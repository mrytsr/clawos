<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron 管理</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1e1e1e; color: #ccc; }
        
        .toolbar {
            display: flex; align-items: center; gap: 12px; padding: 10px 16px;
            background: #2d2d2d; border-bottom: 1px solid #404040;
        }
        button {
            padding: 6px 14px; border-radius: 6px; border: none;
            background: #0e639c; color: #fff; font-size: 13px; cursor: pointer;
        }
        button:hover { background: #1177bb; }
        button.danger { background: #cf222e; }
        button.danger:hover { background: #da3633; }
        button.secondary { background: #3c3c3c; }
        
        .list { flex: 1; overflow: auto; padding: 12px; }
        .job {
            padding: 12px 16px; background: #2d2d2d; border-radius: 8px; margin-bottom: 8px;
            display: flex; align-items: flex-start; gap: 12px;
        }
        .job.disabled { opacity: 0.5; }
        .job-enable { cursor: pointer; font-size: 18px; }
        .job-info { flex: 1; }
        .job-schedule { 
            font-family: 'Consolas', monospace; font-size: 13px; color: #58a6ff; 
            background: #1e1e1e; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px;
        }
        .job-command { font-size: 12px; color: #ccc; word-break: break-all; }
        .job-actions { display: flex; gap: 8px; }
        .job-actions button { padding: 4px 8px; font-size: 12px; }
        .job-actions .btn-run { background: #238636; }
        .job-actions .btn-run:hover { background: #2ea043; }
        
        .empty { text-align: center; padding: 40px; color: #666; }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2d2d2d; border-radius: 12px; padding: 20px; width: 400px; max-width: 90%;
        }
        .modal-title { font-size: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #404040;
            background: #3c3c3c; color: #ccc; font-size: 14px;
        }
        .form-row { display: flex; gap: 8px; }
        .form-row .form-group { flex: 1; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="toolbar">
            <span style="font-size:14px;font-weight:500;">Cron 任务管理</span>
            <button onclick="openAddModal()">+ 添加任务</button>
            <button class="secondary" onclick="loadJobs()">刷新</button>
        </div>
        <div id="list" class="list"></div>
    </div>

    <!-- 添加/编辑弹窗 -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">添加 Cron 任务</div>
            <div class="form-row">
                <div class="form-group">
                    <label>分钟</label>
                    <input type="text" id="minute" value="*" placeholder="*">
                </div>
                <div class="form-group">
                    <label>小时</label>
                    <input type="text" id="hour" value="*" placeholder="*">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>日期</label>
                    <input type="text" id="day" value="*" placeholder="*">
                </div>
                <div class="form-group">
                    <label>月份</label>
                    <input type="text" id="month" value="*" placeholder="*">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>星期</label>
                    <input type="text" id="weekday" value="*" placeholder="0-7">
                </div>
                <div class="form-group">
                    <label>快捷</label>
                    <select id="template" onchange="applyTemplate()">
                        <option value="">自定义</option>
                        <option value="@reboot">系统启动时</option>
                        <option value="@hourly">每小时</option>
                        <option value="0 3 * * *">每天 3:00</option>
                        <option value="0 0 * * 0">每周日</option>
                        <option value="0 0 1 * *">每月 1 号</option>
                        <option value="*/5 * * * *">每 5 分钟</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>命令</label>
                <input type="text" id="command" placeholder="例如: /home/tjx/backup.sh">
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeAddModal()">取消</button>
                <button onclick="addJob()">添加</button>
            </div>
        </div>
    </div>

    <script>
    let jobs = [];
    
    function $(id) { return document.getElementById(id); }
    
    function showStatus(msg) { alert(msg); }
    
    async function loadJobs() {
        try {
            const r = await fetch('/api/cron/list');
            const data = await r.json();
            if (data.success) {
                jobs = (data.data && data.data.jobs) || [];
                render();
            } else {
                alert(data.error || '加载失败');
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    function render() {
        const list = $('list');
        if (jobs.length === 0) {
            list.innerHTML = '<div class="empty">暂无 Cron 任务<br><br>点击"添加任务"创建一个</div>';
            return;
        }
        
        list.innerHTML = jobs.map((job, i) => `
            <div class="job ${!job.enabled ? 'disabled' : ''}">
                <div class="job-enable" onclick="toggleJob(${i})">
                    ${job.enabled ? '✅' : '⏸️'}
                </div>
                <div class="job-info">
                    <div class="job-schedule">${job.minute} ${job.hour} ${job.day} ${job.month} ${job.weekday}</div>
                    <div class="job-command">${job.command}</div>
                </div>
                <div class="job-actions">
                    <button class="btn-run" onclick="runJob(${i})">▶ 执行</button>
                    <button onclick="removeJob(${i})" class="danger">删除</button>
                </div>
            </div>
        `).join('');
    }
    
    function openAddModal() {
        $('addModal').classList.add('open');
        $('minute').value = '*';
        $('hour').value = '*';
        $('day').value = '*';
        $('month').value = '*';
        $('weekday').value = '*';
        $('command').value = '';
        $('template').value = '';
    }
    
    function closeAddModal() {
        $('addModal').classList.remove('open');
    }
    
    function applyTemplate() {
        const tmpl = $('template').value;
        if (tmpl.startsWith('@')) {
            $('minute').value = tmpl;
            $('hour').value = '';
            $('day').value = '';
            $('month').value = '';
            $('weekday').value = '';
        } else {
            const parts = tmpl.split(' ');
            if (parts.length >= 5) {
                $('minute').value = parts[0];
                $('hour').value = parts[1];
                $('day').value = parts[2];
                $('month').value = parts[3];
                $('weekday').value = parts[4];
            }
        }
    }
    
    async function addJob() {
        const minute = $('minute').value || '*';
        const hour = $('hour').value || '*';
        const day = $('day').value || '*';
        const month = $('month').value || '*';
        const weekday = $('weekday').value || '*';
        const command = $('command').value.trim();
        
        if (!command) {
            alert('请输入命令');
            return;
        }
        
        try {
            const r = await fetch('/api/cron/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ minute, hour, day, month, weekday, command })
            });
            const data = await r.json();
            if (data.success) {
                closeAddModal();
                loadJobs();
            } else {
                alert(data.error || '添加失败');
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    async function removeJob(i) {
        if (!confirm('确定删除此任务？')) return;
        try {
            const r = await fetch('/api/cron/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ raw: jobs[i].raw })
            });
            const data = await r.json();
            if (data.success) {
                loadJobs();
            } else {
                alert(data.error || '删除失败');
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    async function toggleJob(i) {
        try {
            const r = await fetch('/api/cron/enable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ raw: jobs[i].raw, enabled: jobs[i].enabled })
            });
            const data = await r.json();
            if (data.success) {
                loadJobs();
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    async function runJob(i) {
        const command = jobs[i].command;
        if (!confirm('立即执行命令：' + command + '\n\n确定继续？')) return;
        
        try {
            const r = await fetch('/api/cron/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command })
            });
            const data = await r.json();
            if (data.success) {
                alert('执行成功！\n\n' + (data.stdout || ''));
            } else {
                alert('执行失败：' + (data.stderr || data.error || '未知错误'));
            }
        } catch (e) {
            alert('执行失败：' + e.message);
        }
    }
    
    loadJobs();
    </script>
</body>
</html>
