<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAML 编辑器</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1e1e1e; }
        
        .toolbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 16px; background: #2d2d2d; border-bottom: 1px solid #404040;
            height: 48px;
        }
        .title { color: #ccc; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .path { color: #888; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .actions { display: flex; gap: 8px; }
        .btn {
            padding: 6px 14px; border-radius: 6px; border: none; font-size: 13px;
            cursor: pointer; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background: #0e639c; color: #fff; }
        .btn-secondary { background: #3c3c3c; color: #ccc; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        #editor { height: calc(100vh - 48px); width: 100%; }
        
        .status {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 6px 16px; font-size: 12px; color: #fff;
            display: flex; justify-content: space-between;
            z-index: 100;
        }
        .status.info { background: #007acc; }
        .status.success { background: #1e7f1e; }
        .status.error { background: #c72e0f; }
        
        .loading {
            position: fixed; inset: 0; background: #1e1e1e;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 32px; height: 32px; border: 3px solid #404040;
            border-top-color: #0e639c; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <div id="main" style="display:none;">
            <div class="toolbar">
                <div style="overflow:hidden;flex:1;">
                    <div id="title" class="title"></div>
                    <div id="path" class="path"></div>
                </div>
                <div class="actions">
                    <button id="fmtBtn" class="btn btn-secondary" onclick="formatDoc()">格式化</button>
                    <button id="saveBtn" class="btn btn-primary" onclick="saveFile()" disabled>保存</button>
                </div>
            </div>
            <div id="editor"></div>
            <div id="status" class="status info" style="display:none;"></div>
        </div>
    </div>

    <script src="/static/lib/monaco/vs/loader.js"></script>
    <script>
    const params = new URLSearchParams(location.search);
    const filepath = params.get('path') || '';
    const filename = filepath.split('/').pop() || 'untitled.yaml';
    
    let editor = null;
    let original = '';
    let changed = false;
    
    const ext = filename.split('.').pop().toLowerCase();
    const langMap = {yaml:'yaml',yml:'yaml',toml:'toml',json:'json',xml:'xml',html:'html',css:'css',js:'javascript',py:'python',md:'markdown',txt:'plaintext'};
    const language = langMap[ext] || 'yaml';
    
    document.getElementById('title').textContent = filename;
    document.getElementById('path').textContent = filepath;
    
    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = 'status ' + (type || 'info');
        el.style.display = 'flex';
        setTimeout(() => { if (el.textContent === msg) el.style.display = 'none'; }, 3000);
    }
    
    function getApiUrl() {
        if (filepath.includes('/usr/local/frp/')) return '/api/frp/config';
        return '/api/file/read?path=' + encodeURIComponent(filepath);
    }
    
    async function loadFile() {
        try {
            const r = await fetch(getApiUrl());
            const data = await r.json();
            if (data.success && data.data) {
                original = data.data.content || '';
                initMonaco(original);
            } else {
                throw new Error(data.error || '加载失败');
            }
        } catch (e) {
            document.getElementById('loading').innerHTML = '<div style="color:#f14c4c;">' + e.message + '</div>';
        }
    }
    
    function initMonaco(content) {
        require.config({ paths: { 'vs': '/static/lib/monaco/vs' }});
        require(['vs/editor/editor.main'], function() {
            // YAML 语言配置
            monaco.languages.register({ id: 'yaml' });
            monaco.languages.setMonarchTokensProvider('yaml', {
                tokenizer: {
                    root: [
                        { include: '@common' },
                    ]
                }
            });
            
            // YAML 智能提示
            monaco.languages.registerCompletionItemProvider('yaml', {
                provideCompletionItems: function(model, position) {
                    return { suggestions: [] };
                }
            });
            
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: content,
                language: language,
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                fontFamily: "'Consolas', 'Monaco', monospace",
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                tabSize: 2,
                insertSpaces: true,
                folding: true,
                bracketPairColorization: { enabled: true }
            });
            
            editor.onDidChangeModelContent(function() {
                const val = editor.getValue();
                if (val !== original) {
                    changed = true;
                    document.getElementById('saveBtn').disabled = false;
                    showStatus('已修改', 'saving');
                }
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            showStatus('已加载');
        });
    }
    
    function formatDoc() {
        if (editor) {
            editor.getAction('editor.action.formatDocument').run();
            showStatus('已格式化');
        }
    }
    
    async function saveFile() {
        if (!editor) return;
        try {
            showStatus('保存中...', 'saving');
            const content = editor.getValue();
            const isFrp = filepath.includes('/usr/local/frp/frpc.toml');
            
            let r, data;
            if (isFrp) {
                r = await fetch('/api/frp/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
            } else {
                r = await fetch('/api/file/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: filepath, content })
                });
            }
            
            data = await r.json();
            if (data.success) {
                original = content;
                changed = false;
                document.getElementById('saveBtn').disabled = true;
                showStatus('保存成功!', 'success');
            } else {
                showStatus('保存失败: ' + (data.error || '未知错误'), 'error');
            }
        } catch (e) {
            showStatus('保存失败: ' + e.message, 'error');
        }
    }
    
    // Ctrl+S 保存
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            if (!document.getElementById('saveBtn').disabled) saveFile();
        }
    });
    
    loadFile();
    </script>
</body>
</html>
