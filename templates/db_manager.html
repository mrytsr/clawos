<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°æ®åº“ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #1a1a2e; color: #e0e0e0; 
        }
        
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* æ‚¬æµ®æŒ‰é’® */
        .float-btn {
            position: fixed; left: 16px; top: 16px; z-index: 100;
            width: 44px; height: 44px; border-radius: 12px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            transition: all 0.3s;
        }
        .float-btn:hover { transform: scale(1.05); }
        .float-btn svg { width: 22px; height: 22px; fill: #fff; }
        
        /* æŠ½å±‰ä¾§è¾¹æ  */
        .drawer {
            position: fixed; left: -100%; top: 0; bottom: 0;
            width: 85%; max-width: 320px; z-index: 200;
            background: #16213e; border-right: 1px solid #0f3460;
            display: flex; flex-direction: column;
            transition: left 0.3s ease;
        }
        .drawer.open { left: 0; }
        
        .drawer-backdrop {
            position: fixed; inset: 0; z-index: 150;
            background: rgba(0,0,0,0.6);
            opacity: 0; visibility: hidden;
            transition: all 0.3s;
        }
        .drawer-backdrop.show { opacity: 1; visibility: visible; }
        
        .drawer-header {
            padding: 14px; border-bottom: 1px solid #0f3460;
            display: flex; align-items: center; justify-content: space-between;
        }
        .drawer-header h2 { font-size: 15px; font-weight: 500; color: #fff; }
        .drawer-close {
            width: 32px; height: 32px; border-radius: 8px;
            background: #0f3460; border: none; color: #888;
            cursor: pointer; font-size: 20px;
        }
        
        .drawer-tabs {
            display: flex; border-bottom: 1px solid #0f3460;
        }
        .drawer-tab {
            flex: 1; padding: 12px; border: none;
            background: transparent; color: #888;
            cursor: pointer; font-size: 13px;
            border-bottom: 2px solid transparent;
        }
        .drawer-tab.active { color: #e94560; border-bottom-color: #e94560; }
        
        .drawer-content { flex: 1; overflow-y: auto; padding: 12px; }
        
        /* è¿æ¥åˆ—è¡¨ */
        .conn-list { display: flex; flex-direction: column; gap: 8px; }
        .conn-item {
            background: #1a1a2e; border-radius: 10px; padding: 12px;
            cursor: pointer; border: 2px solid transparent;
        }
        .conn-item.active { border-color: #e94560; background: #1f1f3a; }
        .conn-item .name { font-size: 14px; font-weight: 500; color: #fff; margin-bottom: 4px; }
        .conn-item .info { font-size: 11px; color: #888; }
        .conn-item .actions { display: flex; gap: 6px; margin-top: 8px; }
        .conn-item .actions button {
            padding: 5px 10px; border-radius: 5px; border: none;
            background: #0f3460; color: #ccc; cursor: pointer; font-size: 11px;
        }
        .conn-item .actions button:hover { background: #e94560; color: #fff; }
        
        /* æ•°æ®åº“æ ‘ */
        .db-tree { }
        .db-group { margin-bottom: 12px; }
        .db-title {
            font-size: 10px; color: #666; text-transform: uppercase;
            padding: 4px 8px; margin-bottom: 2px;
        }
        .db-item {
            padding: 10px 12px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; gap: 10px;
        }
        .db-item.active { background: #0f3460; }
        .db-item .name { flex: 1; font-size: 13px; }
        
        .table-tree { margin-left: 12px; }
        .table-item {
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .table-item.active { background: #0f3460; color: #e94560; }
        .table-item .name { flex: 1; font-size: 12px; }
        .table-item .rows { font-size: 10px; color: #666; }
        
        /* æ–°å»ºæŒ‰é’® */
        .add-btn {
            width: 100%; padding: 12px; border-radius: 8px;
            background: #0f3460; border: none; color: #ccc;
            cursor: pointer; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 12px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1; display: flex; flex-direction: column; 
            padding: 70px 16px 16px 16px; overflow: hidden;
        }
        
        /* é¡¶éƒ¨æ  */
        .top-bar {
            flex-shrink: 0; display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px; flex-wrap: wrap;
        }
        .top-bar h1 { font-size: 18px; font-weight: 500; color: #fff; }
        .breadcrumb { 
            display: flex; align-items: center; gap: 6px; font-size: 12px; color: #888; 
            flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .breadcrumb span { color: #e94560; }
        
        /* å¯æŠ˜å  SQL ç¼–è¾‘å™¨ */
        .sql-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; background: #0f3460; border-radius: 10px;
            cursor: pointer; margin-bottom: 2px;
        }
        .sql-toggle span { font-size: 13px; color: #ccc; }
        .sql-toggle .arrow { 
            transition: transform 0.3s; font-size: 12px; color: #888;
        }
        .sql-toggle.open .arrow { transform: rotate(180deg); }
        
        .sql-editor {
            max-height: 0; overflow: hidden;
            background: #16213e; border-radius: 0 0 10px 10px;
            transition: max-height 0.3s ease;
        }
        .sql-editor.open { max-height: 300px; }
        .sql-editor textarea {
            width: 100%; height: 120px;
            background: #1a1a2e; border: none; border-radius: 8px;
            color: #e0e0e0; font-family: 'SF Mono', 'Consolas', monospace; font-size: 13px;
            padding: 12px; resize: none; outline: none;
        }
        .sql-toolbar { 
            display: flex; gap: 8px; padding: 10px 0; flex-wrap: wrap;
        }
        .sql-toolbar button { 
            padding: 8px 14px; border-radius: 6px; border: none;
            background: #e94560; color: #fff; cursor: pointer; font-size: 12px;
        }
        .sql-toolbar button.secondary { background: #0f3460; }
        .quick-btns { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .quick-btns button { background: #0f3460; border: none; padding: 6px 10px; font-size: 11px; border-radius: 5px; color: #ccc; cursor: pointer; }
        
        /* ç»“æœåŒº */
        .results { 
            flex: 1; overflow: auto; margin-top: 12px;
            background: #16213e; border-radius: 12px; border: 1px solid #0f3460;
        }
        .results-empty { 
            text-align: center; color: #666; padding: 30px; 
            font-size: 13px;
        }
        
        /* æ•°æ®è¡¨ */
        .data-table-wrapper { overflow: auto; max-height: 100%; }
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
        }
        .data-table th, .data-table td {
            padding: 10px 12px; text-align: left; border-bottom: 1px solid #0f3460;
            white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
        }
        .data-table th {
            background: #1a1a2e; color: #e94560; font-weight: 500;
            position: sticky; top: 0; z-index: 10;
        }
        .data-table td { color: #ccc; font-family: 'SF Mono', monospace; font-size: 11px; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            flex-shrink: 0;
            display: flex; align-items: center; gap: 12px; padding: 10px 14px;
            background: #16213e; border-radius: 8px; margin-top: 10px;
            font-size: 11px; color: #888;
        }
        .status-bar .success { color: #4ade80; }
        .status-bar .error { color: #ef4444; }
        
        /* å¼¹çª— */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; z-index: 300;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #16213e; border-radius: 16px; padding: 20px;
            width: 100%; max-width: 380px;
        }
        .modal-title { font-size: 16px; font-weight: 500; margin-bottom: 16px; color: #fff; }
        .modal-content .form-group { margin-bottom: 14px; }
        .modal-content label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .modal-content input, .modal-content select {
            width: 100%; padding: 12px; border-radius: 8px;
            background: #1a1a2e; border: 1px solid #0f3460; color: #fff;
            font-size: 14px;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; }
        .modal-actions .cancel { background: #0f3460; color: #ccc; }
        .modal-actions .confirm { background: #e94560; color: #fff; }
        
        /* ç»“æœ tabs */
        .results-tabs {
            display: flex; gap: 4px; margin-top: 12px; background: #16213e; border-radius: 8px 8px 0 0; padding: 4px 4px 0 4px;
        }
        .results-tab {
            padding: 8px 16px; border-radius: 6px 6px 0 0; border: none;
            background: transparent; color: #888; cursor: pointer; font-size: 12px;
        }
        .results-tab.active { background: #1a1a2e; color: #e94560; }
        .results-panel { 
            display: none; flex: 1; overflow: auto; 
            background: #16213e; border-radius: 0 0 12px 12px; border: 1px solid #0f3460; border-top: none;
        }
        .results-panel.active { display: flex; flex-direction: column; }
        
        /* ç»“æœåŒº */
        .results { 
            flex: 1; overflow: auto; border-radius: 0 0 12px 12px;
        }
        
        /* ç»“æ„è¡¨æ ¼ */
        .schema-table { width: 100%; border-collapse: collapse; }
        .schema-table th, .schema-table td {
            padding: 8px 12px; text-align: left; border-bottom: 1px solid #0f3460;
            font-size: 12px;
        }
        .schema-table th { background: #16213e; color: #e94560; }
        .schema-table td { color: #ccc; font-family: 'SF Mono', monospace; font-size: 11px; }
        .type-tag { display: inline-block; padding: 2px 6px; background: #0f3460; border-radius: 4px; font-size: 10px; color: #888; }
        .key-tag { display: inline-block; padding: 2px 6px; background: #e3b341; color: #000; border-radius: 4px; font-size: 10px; margin-left: 4px; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { 
            display: flex; align-items: center; justify-content: center; padding: 30px; 
            color: #666;
        }
        .spinner {
            width: 18px; height: 18px; border: 2px solid #0f3460;
            border-top-color: #e94560; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app">
        <!-- æ‚¬æµ®æŒ‰é’® -->
        <button class="float-btn" onclick="toggleDrawer()" title="æ•°æ®åº“">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        
        <!-- æŠ½å±‰é®ç½© -->
        <div class="drawer-backdrop" id="drawerBackdrop" onclick="closeDrawer()"></div>
        
        <!-- æŠ½å±‰ä¾§è¾¹æ  -->
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <h2>ğŸ“Š æ•°æ®åº“</h2>
                <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
            </div>
            
            <div class="drawer-tabs">
                <button class="drawer-tab active" id="tabConnections" onclick="switchTab('connections')">è¿æ¥</button>
                <button class="drawer-tab" id="tabDatabases" onclick="switchTab('databases')">æ•°æ®åº“</button>
            </div>
            
            <div class="drawer-content" id="drawerContent">
                <div id="connectionsPanel">
                    <button class="add-btn" onclick="openAddModal()">
                        <span>+</span> æ–°å»ºè¿æ¥
                    </button>
                    <div class="conn-list" id="connList"></div>
                </div>
                
                <div id="databasesPanel" style="display:none;">
                    <div class="db-tree" id="dbTree"></div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content" id="mainContent">
            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <h1>æ•°æ®åº“</h1>
                <div class="breadcrumb" id="breadcrumb">
                    <span>æœªé€‰æ‹©</span>
                </div>
            </div>
            
            <!-- å¯æŠ˜å  SQL ç¼–è¾‘å™¨ -->
            <div class="sql-toggle" id="sqlToggle" onclick="toggleSqlEditor()">
                <span>ğŸ“ SQL æŸ¥è¯¢</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="sql-editor" id="sqlEditorPanel">
                <textarea id="sqlEditor" placeholder="è¾“å…¥ SQL... (Ctrl+Enter æ‰§è¡Œ)"></textarea>
                <div class="sql-toolbar">
                    <button onclick="executeQuery()">â–¶ æ‰§è¡Œ</button>
                    <button class="secondary" onclick="clearEditor()">æ¸…ç©º</button>
                    <div class="quick-btns">
                        <button onclick="quickQuery('SHOW TABLES')">Tables</button>
                        <button onclick="quickQuery('SHOW PROCESSLIST')">Process</button>
                        <button onclick="quickQuery('SHOW STATUS')">Status</button>
                    </div>
                </div>
            </div>
            
            <!-- ç»“æœ -->
            <div class="results-tabs">
                <div class="results-tab active" id="tabResults" onclick="switchResultsTab('results')">æ•°æ®</div>
                <div class="results-tab" id="tabSchema" onclick="switchResultsTab('schema')">ç»“æ„</div>
            </div>
            
            <div class="results-panel active" id="resultsPanel">
                <div class="results" id="resultsContent">
                    <div class="results-empty">é€‰æ‹©è¡¨åè‡ªåŠ¨æŸ¥è¯¢</div>
                </div>
            </div>
            <div class="results-panel" id="schemaPanel">
                <div class="results" id="schemaContent">
                    <div class="results-empty">é€‰æ‹©è¡¨æŸ¥çœ‹ç»“æ„</div>
                </div>
            </div>
            
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar" id="statusBar">
                <span>å°±ç»ª</span>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ è¿æ¥å¼¹çª— -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ–°å»ºè¿æ¥</div>
            
            <!-- URI è§£æ -->
            <div class="form-group">
                <label>è¿æ¥ URIï¼ˆå¯é€‰ï¼‰</label>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="dbUri" placeholder="mysql://user:pass@host:port/db">
                    <button onclick="parseUri()" style="padding:10px 14px;background:#0f3460;border:none;border-radius:8px;color:#ccc;cursor:pointer;">è§£æ</button>
                </div>
            </div>
            
            <hr style="border:none;border-top:1px solid #0f3460;margin:16px 0;">
            
            <div class="form-group">
                <label>åç§°</label>
                <input type="text" id="dbName" placeholder="ä¾‹å¦‚: ç”Ÿäº§åº“">
            </div>
            <div class="form-group">
                <label>ä¸»æœº</label>
                <input type="text" id="dbHost" placeholder="localhost">
            </div>
            <div class="form-group">
                <label>ç«¯å£</label>
                <input type="number" id="dbPort" value="3306">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="dbUser" placeholder="root">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="dbPass" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="dbDatabase" placeholder="å¯ç¨åé€‰æ‹©">
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="testAndSave()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let connections = [];
        let currentConn = null;
        let currentDb = null;
        let currentTable = null;
        let expandedDatabases = [];
        let sqlHistory = [];
        let lastSql = '';
        
        // ä»æœåŠ¡ç«¯åŠ è½½çŠ¶æ€
        async function loadStateFromServer() {
            try {
                const r = await fetch('/api/db/state');
                const data = await r.json();
                if (data.success && data.data) {
                    return data.data;
                }
            } catch (e) { console.error('Load state failed:', e); }
            return {};
        }
        
        // ä¿å­˜çŠ¶æ€åˆ°æœåŠ¡ç«¯
        async function saveStateToServer() {
            const state = {
                connId: currentConn?.id || null,
                dbName: currentDb || null,
                tableName: currentTable || null,
                expandedDatabases: expandedDatabases,
                lastSql: lastSql,
                sqlHistory: sqlHistory
            };
            try {
                await fetch('/api/db/state', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(state)
                });
            } catch (e) { console.error('Save state failed:', e); }
        }
        
        // æœ¬åœ° SQL å†å²
        function loadLocalSqlHistory() {
            sqlHistory = JSON.parse(localStorage.getItem('db_sql_history') || '[]');
        }
        
        function saveLocalSqlHistory() {
            localStorage.setItem('db_sql_history', JSON.stringify(sqlHistory));
        }
        
        // ä¿å­˜ SQL åˆ°å†å²
        function addSqlToHistory(sql) {
            if (!sql || sql.trim().length < 3) return;
            sqlHistory = sqlHistory.filter(s => s !== sql);
            sqlHistory.unshift(sql);
            sqlHistory = sqlHistory.slice(0, 50);
            saveLocalSqlHistory();
            saveStateToServer();
        }
        
        // æ˜¾ç¤º SQL å†å²
        function showSqlHistory() {
            if (sqlHistory.length === 0) return;
            
            let html = '<div style="padding:8px 12px;border-bottom:1px solid #0f3460;font-size:11px;color:#888;">å†å²è®°å½•</div>';
            sqlHistory.forEach((sql, i) => {
                const shortSql = sql.length > 40 ? sql.substring(0, 40) + '...' : sql;
                html += `
                    <div class="table-item" onclick="useHistorySql('${sql.replace(/'/g, "\\'")}')" 
                         style="padding:8px 12px 8px 24px;font-size:11px;border-bottom:1px solid #0f3460;">
                        ${shortSql}
                    </div>
                `;
            });
            return html;
        }
        
        function useHistorySql(sql) {
            $('sqlEditor').value = sql;
            // å±•å¼€ç¼–è¾‘å™¨
            $('sqlEditorPanel').classList.add('open');
            $('sqlToggle').classList.add('open');
        }
        
        // ä¸‹æ‹‰åˆ·æ–°ï¼ˆæ•´ä¸ªé¡µé¢ï¼‰
        let isRefreshing = false;
        let lastScrollTop = 0;
        let pullStartY = 0;
        let pullDistance = 0;
        
        function initPullRefresh() {
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', async () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // åœ¨é¡¶éƒ¨ä¸”å‘ä¸‹æ‹‰æ—¶è§¦å‘
                if (scrollTop === 0 && lastScrollTop > 0 && !isRefreshing && currentConn) {
                    isRefreshing = true;
                    showStatus('åˆ·æ–°ä¸­...', false);
                    
                    if (currentDb) {
                        await loadDatabases();
                    } else {
                        await loadConnections();
                    }
                    
                    setTimeout(() => {
                        isRefreshing = false;
                        showStatus('å·²åˆ·æ–°', false);
                    }, 500);
                }
                
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            }, { passive: true });
        }
        
        // SQL ç¼–è¾‘å™¨å¼€å…³
        function toggleSqlEditor() {
            const panel = $('sqlEditorPanel');
            const toggle = $('sqlToggle');
            panel.classList.toggle('open');
            toggle.classList.toggle('open');
            
            // å¦‚æœå±•å¼€ï¼Œæ˜¾ç¤ºå†å²è®°å½•
            if (panel.classList.contains('open')) {
                const historyHtml = showSqlHistory();
                if (historyHtml) {
                    // åœ¨ç¼–è¾‘å™¨ä¸‹æ–¹æ·»åŠ å†å²è®°å½•
                    let historyEl = $('sqlHistoryPanel');
                    if (!historyEl) {
                        historyEl = document.createElement('div');
                        historyEl.id = 'sqlHistoryPanel';
                        historyEl.style.cssText = 'max-height:200px;overflow-y:auto;background:#1a1a2e;border-radius:8px;margin-top:8px;';
                        panel.insertBefore(historyEl, panel.querySelector('.sql-toolbar'));
                    }
                    historyEl.innerHTML = historyHtml;
                }
            }
        }
        
        // æŠ½å±‰æ§åˆ¶
        function toggleDrawer() {
            $('drawer').classList.toggle('open');
            $('drawerBackdrop').classList.toggle('show');
        }
        
        function closeDrawer() {
            $('drawer').classList.remove('open');
            $('drawerBackdrop').classList.remove('show');
        }
        
        // Tab åˆ‡æ¢
        function switchTab(tab) {
            document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
            $('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            $('connectionsPanel').style.display = tab === 'connections' ? 'block' : 'none';
            $('databasesPanel').style.display = tab === 'databases' ? 'block' : 'none';
            if (tab === 'databases' && currentConn) loadDatabases();
        }
        
        const $ = id => document.getElementById(id);
        
        function showStatus(msg, error) {
            const bar = $('statusBar');
            bar.innerHTML = `<span class="${error ? 'error' : 'success'}">${msg}</span>`;
        }
        
        function updateBreadcrumb() {
            let html = '';
            if (currentConn) {
                html += `<span>${currentConn.name}</span>`;
                if (currentDb) {
                    html += ` / <span>${currentDb}</span>`;
                    if (currentTable) html += ` / <span>${currentTable}</span>`;
                }
            } else {
                html = '<span>æœªé€‰æ‹©</span>';
            }
            $('breadcrumb').innerHTML = html;
            saveStateToServer();
        }
        
        async function loadConnections() {
            // åŠ è½½æœ¬åœ° SQL å†å²
            loadLocalSqlHistory();
            
            try {
                const r = await fetch('/api/db/connections');
                const data = await r.json();
                if (data.success) {
                    connections = data.data?.connections || [];
                    renderConnections();
                    // æ¢å¤çŠ¶æ€
                    restoreSession();
                }
            } catch (e) { console.error(e); }
        }
        
        // æ¢å¤ä¼šè¯
        async function restoreSession() {
            const state = await loadStateFromServer();
            if (!state || !state.connId) return;
            
            const conn = connections.find(c => c.id === state.connId);
            if (conn) {
                currentConn = conn;
                // æ¢å¤å±•å¼€çš„æ•°æ®åº“
                expandedDatabases = state.expandedDatabases || [];
                // æ¢å¤ SQL å†å²
                sqlHistory = state.sqlHistory || [];
                lastSql = state.lastSql || '';
                if (lastSql) $('sqlEditor').value = lastSql;
                
                renderConnections();
                updateBreadcrumb();
                await loadDatabases();
                switchTab('databases');
                
                // æ¢å¤å±•å¼€çš„æ•°æ®åº“å’Œé€‰ä¸­çš„è¡¨
                for (const dbName of expandedDatabases) {
                    const tablesEl = $('tables-' + dbName);
                    if (tablesEl) {
                        tablesEl.style.display = 'block';
                        $('db-' + dbName)?.classList.add('active');
                    }
                }
                
                if (state.dbName) {
                    currentDb = state.dbName;
                    updateBreadcrumb();
                    
                    // æ¢å¤è¡¨é€‰æ‹©
                    if (state.tableName) {
                        // ç­‰å¾…è¡¨æ ¼åŠ è½½å®Œæˆåå†é«˜äº®
                        setTimeout(() => {
                            const tableEl = $('table-' + state.tableName);
                            if (tableEl) {
                                currentTable = state.tableName;
                                tableEl.classList.add('active');
                                // å±•å¼€ç¼–è¾‘å™¨
                                $('sqlEditorPanel').classList.add('open');
                                $('sqlToggle').classList.add('open');
                            }
                        }, 800);
                    }
                }
            }
        }
        
        function renderConnections() {
            let html = '';
            connections.forEach(c => {
                const active = currentConn?.id === c.id ? 'active' : '';
                html += `
                    <div class="conn-item ${active}" onclick="selectConnection('${c.id}')">
                        <div class="name">${c.name}</div>
                        <div class="info">${c.host}:${c.port} | ${c.user}</div>
                        <div class="actions">
                            <button onclick="event.stopPropagation(); deleteConnection('${c.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            $('connList').innerHTML = html || '<div class="results-empty">æš‚æ— è¿æ¥</div>';
        }
        
        async function selectConnection(id) {
            currentConn = connections.find(c => c.id === id);
            currentDb = null;
            currentTable = null;
            expandedDatabases = [];
            renderConnections();
            updateBreadcrumb();
            await loadDatabases();
            switchTab('databases');
            saveStateToServer();
        }
        
        async function loadDatabases() {
            if (!currentConn) return;
            $('dbTree').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const r = await fetch(`/api/db/${currentConn.id}/databases`);
                const data = await r.json();
                if (data.success) renderDatabases(data.data?.databases || []);
            } catch (e) { $('dbTree').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>'; }
        }
        
        function renderDatabases(dbs) {
            let html = '';
            dbs.forEach(db => {
                const active = currentDb === db ? 'active' : '';
                html += `
                    <div class="db-group">
                        <div class="db-title">${db}</div>
                        <div class="db-item ${active}" onclick="selectDatabase('${db}')" id="db-${db}">
                            <span>ğŸ“</span>
                            <span class="name">${db}</span>
                        </div>
                        <div class="table-tree" id="tables-${db}" style="display:none;"></div>
                    </div>
                `;
            });
            $('dbTree').innerHTML = html || '<div class="results-empty">æš‚æ— æ•°æ®åº“</div>';
        }
        
        async function selectDatabase(dbName, shouldSave = true) {
            // å¦‚æœç‚¹å‡»å·²å±•å¼€çš„æ•°æ®åº“ï¼Œæ”¶èµ·è¡¨æ ¼åˆ—è¡¨
            if (currentDb === dbName && shouldSave) {
                const tablesEl = $('tables-' + dbName);
                if (tablesEl && tablesEl.style.display !== 'none') {
                    tablesEl.style.display = 'none';
                    $('db-' + dbName)?.classList.remove('active');
                    currentDb = null;
                    currentTable = null;
                    expandedDatabases = expandedDatabases.filter(d => d !== dbName);
                    updateBreadcrumb();
                    if (shouldSave) saveStateToServer();
                    return;
                }
            }
            
            currentDb = dbName;
            currentTable = null;
            // æ·»åŠ åˆ°å±•å¼€åˆ—è¡¨
            if (!expandedDatabases.includes(dbName)) {
                expandedDatabases.push(dbName);
            }
            updateBreadcrumb();
            document.querySelectorAll('.db-item').forEach(el => el.classList.remove('active'));
            $('db-' + dbName)?.classList.add('active');
            document.querySelectorAll('.table-tree').forEach(el => el.style.display = 'none');
            const tablesEl = $('tables-' + dbName);
            tablesEl.style.display = 'block';
            await loadTables(dbName, tablesEl);
            if (shouldSave) saveStateToServer();
        }
        
        async function loadTables(dbName, container) {
            container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const r = await fetch(`/api/db/${currentConn.id}/tables?database=${encodeURIComponent(dbName)}`);
                const data = await r.json();
                if (data.success) renderTables(data.data?.tables || [], container);
            } catch (e) { container.innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>'; }
        }
        
        function renderTables(tables, container) {
            let html = tables.length === 0 
                ? '<div class="results-empty" style="padding:8px;font-size:11px;">æ— è¡¨</div>'
                : tables.map(t => `
                    <div class="table-item" onclick="selectTable('${t.name}')" id="table-${t.name}">
                        <span>ğŸ“‹</span>
                        <span class="name">${t.name}</span>
                        <span class="rows">${parseInt(t.rows||0).toLocaleString()}</span>
                    </div>
                `).join('');
            container.innerHTML = html;
        }
        
        async function selectTable(tableName) {
            currentTable = tableName;
            updateBreadcrumb();
            document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
            $('table-' + tableName)?.classList.add('active');
            
            // ç¡®ä¿ SQL ç¼–è¾‘å™¨å±•å¼€
            $('sqlEditorPanel').classList.add('open');
            $('sqlToggle').classList.add('open');
            
            const sql = `SELECT * FROM \`${tableName}\` LIMIT 100`;
            $('sqlEditor').value = sql;
            lastSql = sql;
            
            // åˆ‡æ¢åˆ°æ•°æ® tab
            switchResultsTab('results');
            
            await executeQuery();
            
            // é¢„åŠ è½½è¡¨ç»“æ„
            loadTableSchema();
            
            saveStateToServer();
        }
        
        async function executeQuery() {
            if (!currentConn) { showStatus('è¯·å…ˆé€‰æ‹©è¿æ¥', true); return; }
            const sql = $('sqlEditor').value.trim();
            if (!sql) return;
            $('resultsContent').innerHTML = '<div class="loading"><div class="spinner"></div>æ‰§è¡Œä¸­...</div>';
            
            // ä¿å­˜ SQL åˆ°å†å²
            addSqlToHistory(sql);
            lastSql = sql;
            
            try {
                const r = await fetch('/api/db/execute', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ connection: currentConn.id, query: sql })
                });
                const data = await r.json();
                if (data.success) {
                    renderResults(data.data);
                    showStatus(`æˆåŠŸï¼Œè¿”å› ${data.data?.rows?.length || 0} è¡Œ`, false);
                } else {
                    showStatus('å¤±è´¥: ' + data.message, true);
                    $('resultsContent').innerHTML = `<div class="results-empty" style="color:#ef4444;">${data.message}</div>`;
                }
            } catch (e) {
                showStatus('å¤±è´¥: ' + e.message, true);
                $('resultsContent').innerHTML = `<div class="results-empty" style="color:#ef4444;">${e.message}</div>`;
            }
        }
        
        function renderResults(data) {
            const headers = data.headers || [];
            const rows = data.rows || [];
            $('resultsContent').innerHTML = rows.length === 0 
                ? '<div class="results-empty">æ— æ•°æ®</div>' 
                : `<div class="data-table-wrapper"><table class="data-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.map(row => `<tr>${row.map(cell => `<td>${cell||''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        }
        
        // åˆ‡æ¢ç»“æœ tabs
        function switchResultsTab(tab) {
            document.querySelectorAll('.results-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.results-panel').forEach(p => p.classList.remove('active'));
            
            const tabEl = $('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const panelEl = document.getElementById(tab + 'Panel');
            
            if (tabEl) tabEl.classList.add('active');
            if (panelEl) panelEl.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°ç»“æ„ tab ä¸”æœ‰é€‰ä¸­çš„è¡¨ï¼ŒåŠ è½½ç»“æ„
            if (tab === 'schema' && currentTable) {
                const schemaContent = $('schemaContent');
                if (schemaContent && !schemaContent.querySelector('.schema-table')) {
                    loadTableSchema();
                }
            }
        }
        
        // åŠ è½½è¡¨ç»“æ„
        async function loadTableSchema() {
            if (!currentConn || !currentTable) return;
            
            $('schemaContent').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            
            try {
                const r = await fetch(`/api/db/${currentConn.id}/table/${currentTable}/schema`);
                const data = await r.json();
                
                if (data.success) {
                    const cols = data.data?.columns || [];
                    const idxs = data.data?.indexes || [];
                    
                    if (cols.length === 0) {
                        $('schemaContent').innerHTML = '<div class="results-empty">æ— ç»“æ„ä¿¡æ¯</div>';
                        return;
                    }
                    
                    let html = '<div style="padding:8px;font-size:11px;color:#888;">' + 
                               `${currentTable} - ${cols.length} åˆ—, ${idxs.length} ç´¢å¼•</div>`;
                    html += '<table class="schema-table"><thead><tr><th>åˆ—å</th><th>ç±»å‹</th><th>å¯ç©º</th><th>é”®</th><th>é»˜è®¤å€¼</th></tr></thead><tbody>';
                    
                    cols.forEach(c => {
                        html += `<tr>
                            <td style="color:#58a6ff;font-weight:500;">${c.field}</td>
                            <td><span class="type-tag">${c.type}</span></td>
                            <td>${c.null === 'YES' ? 'âœ“' : 'âœ—'}</td>
                            <td>${c.key ? '<span class="key-tag">KEY</span>' : ''}</td>
                            <td>${c.default || '-'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    
                    if (idxs.length > 0) {
                        html += '<div style="padding:12px 8px 8px;font-size:11px;color:#888;">ç´¢å¼•</div>';
                        html += '<table class="schema-table"><thead><tr><th>ç´¢å¼•å</th><th>åˆ—</th><th>å”¯ä¸€</th></tr></thead><tbody>';
                        idxs.forEach(i => {
                            html += `<tr><td>${i.name}</td><td>${i.columns}</td><td>${i.unique ? 'æ˜¯' : 'å¦'}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    
                    $('schemaContent').innerHTML = html;
                } else {
                    $('schemaContent').innerHTML = '<div class="results-empty">' + (data.message || 'åŠ è½½å¤±è´¥') + '</div>';
                }
            } catch (e) {
                $('schemaContent').innerHTML = '<div class="results-empty">' + e.message + '</div>';
            }
        }
        
        function quickQuery(sql) {
            if (!currentConn) { showStatus('è¯·å…ˆé€‰æ‹©è¿æ¥', true); return; }
            $('sqlEditor').value = sql;
            switchResultsTab('results');
            executeQuery();
        }
        
        function clearEditor() { $('sqlEditor').value = ''; }
        
        // è§£æ URI
        function parseUri() {
            const uri = $('dbUri').value.trim();
            if (!uri) return;
            
            // æ”¯æŒæ ¼å¼: mysql://user:pass@host:port/database
            const regex = /^(mysql|postgres|postgresql):\/\/([^:]+):([^@]+)@([^:]+):(\d+)\/([^/?]+)/;
            const match = uri.match(regex);
            
            if (match) {
                $('dbHost').value = match[4];
                $('dbPort').value = match[5];
                $('dbUser').value = match[2];
                $('dbPass').value = match[3];
                $('dbDatabase').value = match[6];
                
                // å¦‚æœåç§°ä¸ºç©ºï¼Œç”¨ host ä½œä¸ºé»˜è®¤åç§°
                if (!$('dbName').value) {
                    $('dbName').value = match[4];
                }
                
                showStatus('URI è§£ææˆåŠŸ', false);
            } else {
                // å°è¯•ç®€å•è§£æ
                const simpleMatch = uri.match(/^([^:]+):\/\/([^@]+)@([^:/]+):?(\d+)?:?\/([^/?]+)?/);
                if (simpleMatch) {
                    $('dbHost').value = simpleMatch[3];
                    if (simpleMatch[4]) $('dbPort').value = simpleMatch[4];
                    const creds = simpleMatch[2].split(':');
                    if (creds[0]) $('dbUser').value = creds[0];
                    if (creds[1]) $('dbPass').value = creds[1];
                    if (simpleMatch[5]) $('dbDatabase').value = simpleMatch[5];
                    showStatus('URI è§£ææˆåŠŸ', false);
                } else {
                    showStatus('æ— æ³•è§£æ URI æ ¼å¼', true);
                }
            }
        }
        
        function openAddModal() { $('addModal').classList.add('show'); }
        function closeAddModal() { $('addModal').classList.remove('show'); }
        
        async function testAndSave() {
            const data = { name: $('dbName').value, host: $('dbHost').value, port: $('dbPort').value||'3306', user: $('dbUser').value, password: $('dbPass').value, database: $('dbDatabase').value };
            if (!data.name || !data.host || !data.user) { alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯'); return; }
            try {
                const r = await fetch('/api/db/test', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const result = await r.json();
                if (result.success) {
                    await fetch('/api/db/connect', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                    closeAddModal();
                    loadConnections();
                    showStatus('å·²ä¿å­˜', false);
                } else { alert('è¿æ¥å¤±è´¥: ' + result.message); }
            } catch (e) { alert('è¿æ¥å¤±è´¥: ' + e.message); }
        }
        
        async function deleteConnection(id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            try {
                const r = await fetch(`/api/db/connection/${id}`, {method: 'DELETE'});
                if (r.json().success) { currentConn = null; currentDb = null; currentTable = null; loadConnections(); updateBreadcrumb(); }
            } catch (e) { showStatus('åˆ é™¤å¤±è´¥', true); }
        }
        
        document.addEventListener('keydown', e => { if ((e.ctrlKey||e.metaKey) && e.key==='Enter') executeQuery(); });
        
        // åˆå§‹åŒ–
        loadConnections();
        initPullRefresh();
    </script>
</body>
</html>
