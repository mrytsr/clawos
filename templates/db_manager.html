<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°æ®åº“ç®¡ç†</title>
    <script src="/static/js/clipboard.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e; color: #e0e0e0;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* æ‚¬æµ®æŒ‰é’® */
        .float-btn {
            position: fixed; left: 16px; bottom: 40px; z-index: 100;
            width: 44px; height: 44px; border-radius: 12px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
        }
        .float-btn:hover { transform: scale(1.05); }
        .float-btn svg { width: 22px; height: 22px; fill: #fff; }
        
        /* æŠ½å±‰ä¾§è¾¹æ  */
        .drawer {
            position: fixed; left: -100%; top: 0; bottom: 0;
            width: 60%; max-width: 320px; z-index: 200;
            background: #16213e; border-right: 1px solid #0f3460;
            display: flex; flex-direction: column;
            transition: left 0.3s ease;
        }
        .drawer.open { left: 0; }
        .drawer-backdrop {
            position: fixed; inset: 0; z-index: 150;
            background: rgba(0,0,0,0.6);
            opacity: 0; visibility: hidden;
        }
        .drawer-backdrop.show { opacity: 1; visibility: visible; }
        .drawer-header {
            padding: 14px; border-bottom: 1px solid #0f3460;
            display: flex; align-items: center; justify-content: space-between;
        }
        .drawer-header h2 { font-size: 15px; font-weight: 500; color: #fff; }
        .drawer-close {
            width: 32px; height: 32px; border-radius: 8px;
            background: #0f3460; border: none; color: #888;
            cursor: pointer; font-size: 20px;
        }
        .drawer-content { flex: 1; overflow-y: auto; padding: 12px; }
        
        /* æ ‘ç»„ä»¶ */
        .tree { font-size: 13px; }
        .tree-node { }
        .tree-node-content {
            padding: 8px 10px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: background 0.15s;
        }
        .tree-node-content:hover { background: #0f3460; }
        .tree-node-content.active { background: #0f3460; color: #e94560; }
        .tree-toggle {
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #666; flex-shrink: 0;
        }
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-icon { width: 18px; text-align: center; flex-shrink: 0; }
        .tree-label { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tree-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
        .tree-node-content:hover .tree-actions { opacity: 1; }
        .tree-actions button {
            padding: 2px 6px; border-radius: 4px; border: none;
            background: rgba(255,255,255,0.1); color: #888; cursor: pointer; font-size: 10px;
        }
        .tree-actions button:hover { background: #e94560; color: #fff; }
        .tree-children { padding-left: 20px; overflow: hidden; }
        .tree-children.collapsed { display: none; }
        .tree-loading { padding: 10px; text-align: center; color: #666; font-size: 12px; }
        
        /* æ–°å»ºæŒ‰é’® */
        .add-btn {
            width: 100%; padding: 10px; border-radius: 8px;
            background: #0f3460; border: none; color: #ccc;
            cursor: pointer; font-size: 13px; margin-bottom: 12px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1; display: flex; flex-direction: column;
            padding: 5px 16px 16px 16px; overflow: hidden;
        }
        .top-bar {
            flex-shrink: 0; display: flex; align-items: center; gap: 8px;
            margin-bottom: 4px; flex-wrap: wrap;
        }
        .top-bar h1 { font-size: 18px; font-weight: 500; color: #fff; }
        .breadcrumb {
            display: flex; align-items: center; gap: 6px; font-size: 12px; color: #888;
            flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .breadcrumb span { color: #e94560; }
        
        /* SQL ç¼–è¾‘å™¨ */
        .sql-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; background: #0f3460; border-radius: 10px;
            cursor: pointer; margin-bottom: 2px;
        }
        .sql-toggle span { font-size: 13px; color: #ccc; }
        .sql-toggle .arrow { transition: transform 0.3s; font-size: 12px; color: #888; }
        .sql-toggle.open .arrow { transform: rotate(180deg); }
        .sql-editor {
            display: none; flex-direction: column;
            background: #16213e; border-radius: 10px; padding: 12px;
        }
        .sql-editor.open { display: flex; }
        .sql-editor-wrapper { position: relative; }
        .sql-editor textarea {
            width: 100%; height: 80px; background: #1a1a2e; border: none;
            padding: 12px; resize: none; outline: none;
            color: #fff; font-family: 'SF Mono', monospace; font-size: 12px;
            border-radius: 6px;
        }
        .sql-autocomplete {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #1a1a2e; border: 1px solid #0f3460;
            border-radius: 6px; max-height: 150px; overflow-y: auto;
            z-index: 100;
        }
        .sql-autocomplete-item {
            padding: 8px 12px; cursor: pointer; color: #ccc;
            font-family: 'SF Mono', monospace; font-size: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .sql-autocomplete-item:hover, .sql-autocomplete-item.selected {
            background: #0f3460; color: #fff;
        }
        .sql-autocomplete-item .type-tag {
            font-size: 10px; padding: 2px 6px; border-radius: 4px;
            background: #2d2d2d; color: #888;
        }
        .sql-autocomplete-item .type-tag.key { background: #1e3a5f; color: #58a6ff; }
        .sql-autocomplete-item .type-tag.func { background: #3d5a3d; color: #7ee787; }
        .sql-autocomplete-item .type-tag.col { background: #5a3d2d; color: #f0883e; }
        .sql-autocomplete-item .type-tag.tbl { background: #3d3d5a; color: #a371f7; }
        .sql-autocomplete-item .type-tag.his { background: #5a3d5a; color: #db61a2; }
        .sql-toolbar { display: flex; gap: 8px; padding: 10px 0; flex-wrap: wrap; align-items: center; }
        .sql-toolbar button {
            padding: 8px 14px; border-radius: 6px; border: none;
            background: #e94560; color: #fff; cursor: pointer; font-size: 12px;
        }
        .sql-toolbar button.secondary { background: #0f3460; }
        .quick-btns { display: flex; gap: 6px; flex-wrap: wrap; margin-left: auto; }
        .quick-btns button {
            background: #0f3460; border: none; padding: 6px 10px; font-size: 11px;
            border-radius: 5px; color: #ccc; cursor: pointer;
        }
        .sql-history-list { display: flex; flex-direction: column; gap: 4px; }
        .sql-history-item {
            padding: 10px 12px; border-radius: 6px; background: #1a1a2e;
            cursor: pointer; font-size: 12px; color: #ccc;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .sql-history-item:hover { background: #0f3460; }
        .sql-history-item .sql-text { font-family: 'SF Mono', monospace; font-size: 11px; }
        .sql-history-item .sql-time { font-size: 10px; color: #666; margin-top: 4px; }
        .history-divider { height: 1px; background: #0f3460; margin: 12px 0; }
        .history-section-title {
            font-size: 11px; color: #888; padding: 8px 0 4px; margin-bottom: 4px;
        }
        
        /* å¯¼å‡ºå’Œåˆ†é¡µ */
        .results-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; gap: 16px;
        }
        .export-btns { display: flex; gap: 6px; }
        .export-btn {
            padding: 4px 10px; font-size: 11px; border-radius: 4px;
            background: #0f3460; border: none; color: #ccc; cursor: pointer;
        }
        .pagination { display: flex; align-items: center; gap: 8px; }
        .page-btn {
            padding: 4px 8px; font-size: 11px; border-radius: 4px;
            background: #0f3460; border: none; color: #ccc; cursor: pointer;
        }
        .page-info { font-size: 11px; color: #888; min-width: 60px; text-align: center; }
        
        /* ç»“æœåŒº */
        .results-tabs { display: flex; gap: 4px; padding: 8px 0; }
        .results-tab {
            padding: 6px 12px; border-radius: 6px; border: none;
            background: transparent; color: #888; cursor: pointer; font-size: 12px;
        }
        .results-tab.active { background: #0f3460; color: #e94560; }
        .results {
            flex: 1; overflow: auto; background: #16213e; border-radius: 12px;
            border: 1px solid #0f3460;
        }
        .results-empty { text-align: center; color: #666; padding: 30px; }
        .loading { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 20px; color: #666; }
        .spinner {
            width: 18px; height: 18px; border: 2px solid #0f3460;
            border-top-color: #e94560; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* æ•°æ®è¡¨æ ¼ */
        .data-table-wrapper { overflow: auto; max-height: 100%; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table th, .data-table td {
            padding: 10px 12px; text-align: left; border-bottom: 1px solid #0f3460;
            white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
        }
        .data-table th {
            background: #1a1a2e; color: #e94560; font-weight: 500;
            position: sticky; top: 0; z-index: 10;
        }
        .data-table td { color: #ccc; font-family: 'SF Mono', monospace; font-size: 11px; cursor: pointer; }
        .data-table td:hover { background: #1a2a4a; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            flex-shrink: 0;
            display: flex; align-items: center; gap: 12px; padding: 10px 14px;
            background: #16213e; border-radius: 8px; margin-top: 10px;
            font-size: 11px; color: #888;
        }
        .status-bar .success { color: #4ade80; }
        .status-bar .error { color: #ef4444; }
        
        /* å¼¹çª— */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; z-index: 300;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content { background: #16213e; border-radius: 12px; padding: 20px; max-width: 360px; width: 100%; }
        .modal-title { font-size: 16px; font-weight: 500; margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #0f3460;
            border-radius: 8px; color: #fff; font-size: 14px;
        }
        .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        .modal-actions button {
            flex: 1; padding: 12px; border-radius: 8px; border: none;
            cursor: pointer; font-size: 14px;
        }
        .modal-actions .cancel { background: #0f3460; color: #ccc; }
        .modal-actions .confirm { background: #e94560; color: #fff; }
    </style>
</head>
<body>
    <div id="app">
        <!-- æ‚¬æµ®æŒ‰é’® -->
        <button class="float-btn" onclick="toggleDrawer()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        
        <!-- æŠ½å±‰é®ç½© -->
        <div class="drawer-backdrop" id="drawerBackdrop" onclick="closeDrawer()"></div>
        
        <!-- æŠ½å±‰ -->
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <h2>ğŸ“Š æ•°æ®åº“</h2>
                <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
            </div>
            <div class="drawer-content">
                <button class="add-btn" onclick="openAddModal()">+ æ–°å»ºè¿æ¥</button>
                <div class="tree" id="dbTree"></div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="top-bar">
                <h1>æ•°æ®åº“</h1>
                <div class="breadcrumb" id="breadcrumb"><span>æœªé€‰æ‹©</span></div>
            </div>
            
            <!-- SQL ç¼–è¾‘å™¨ -->
            <div class="sql-toggle" id="sqlToggle" onclick="toggleSqlEditor()">
                <span>ğŸ“ SQL æŸ¥è¯¢</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="sql-editor" id="sqlEditorPanel">
                <div class="sql-editor-wrapper">
                    <textarea id="sqlEditor" placeholder="è¾“å…¥ SQL... (Ctrl+Enter æ‰§è¡Œ)"></textarea>
                    <div class="sql-autocomplete" id="sqlAutocomplete" style="display:none;"></div>
                </div>
                <div class="sql-toolbar">
                    <button onclick="executeQuery()">â–¶ æ‰§è¡Œ</button>
                    <button class="secondary" onclick="clearEditor()">æ¸…ç©º</button>
                    <button class="secondary" onclick="openSqlHistory()">å†å²</button>
                    <button class="secondary" onclick="sqlHistoryPrev()">ä¸Šä¸€æ¡</button>
                    <button class="secondary" onclick="sqlHistoryNext()">ä¸‹ä¸€æ¡</button>
                </div>
            </div>
            
            <!-- SQL å†å²ä¾§è¾¹æ  -->
            <div class="drawer-backdrop" id="historyBackdrop" onclick="closeSqlHistory()"></div>
            <div class="drawer" id="historyDrawer" style="width:50%;max-width:280px;">
                <div class="drawer-header">
                    <h2>ğŸ“œ SQL å†å²</h2>
                    <button class="drawer-close" onclick="closeSqlHistory()">Ã—</button>
                </div>
                <div class="drawer-content">
                    <div style="font-size:11px;color:#888;margin-bottom:8px;">å¸¸ç”¨</div>
                    <div class="sql-history-list" id="sqlHistoryList"></div>
                </div>
            </div>
            
            <!-- å·¥å…·æ  -->
            <div class="results-toolbar" id="resultsToolbar" style="display:none;">
                <div class="export-btns">
                    <button class="export-btn" onclick="exportData('csv')">CSV</button>
                    <button class="export-btn" onclick="exportData('xls')">XLS</button>
                    <button class="export-btn" onclick="exportData('sql')">SQL</button>
                </div>
                <div class="pagination" id="paginationControls">
                    <button class="page-btn" onclick="goToPage(1)">Â«</button>
                    <button class="page-btn" onclick="goToPage(currentPage-1)">â€¹</button>
                    <span class="page-info" id="pageInfo">1 / 1</span>
                    <button class="page-btn" onclick="goToPage(currentPage+1)">â€º</button>
                    <button class="page-btn" onclick="goToPage(totalPages)">Â»</button>
                </div>
            </div>
            
            <!-- ç»“æœ -->
            <div class="results-tabs">
                <button class="results-tab active" id="tabResults" onclick="switchResultsTab('results')">æ•°æ®</button>
                <button class="results-tab" id="tabSchema" onclick="switchResultsTab('schema')">ç»“æ„</button>
            </div>
            <div class="results" id="resultsContent">
                <div class="results-empty">é€‰æ‹©è¡¨åè‡ªåŠ¨æŸ¥è¯¢</div>
            </div>
            <div class="results" id="schemaPanel" style="display:none;">
                <div class="results-empty">é€‰æ‹©è¡¨æŸ¥çœ‹ç»“æ„</div>
            </div>
            
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar" id="statusBar"><span>å°±ç»ª</span></div>
        </div>
    </div>
    
    <!-- æ·»åŠ è¿æ¥å¼¹çª— -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ–°å»ºè¿æ¥</div>
            <div class="form-group">
                <label>æ•°æ®åº“å¼•æ“</label>
                <select id="dbEngine">
                    <option value="mysql">MySQL</option>
                    <option value="postgresql">PostgreSQL</option>
                    <option value="sqlite">SQLite</option>
                    <option value="mariadb">MariaDB</option>
                    <option value="oracle">Oracle</option>
                    <option value="mssql">SQL Server</option>
                </select>
            </div>
            <div class="form-group">
                <label>URL</label>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="dbUrl" placeholder="mysql+pymysql://user:pass@host:3306/db">
                    <button onclick="applyDbUrl(true)" style="background:#0f3460;border:none;border-radius:8px;color:#ccc;cursor:pointer;padding:0 12px;">è§£æ</button>
                </div>
            </div>
            <div class="form-group"><label>åç§°</label><input type="text" id="dbName" placeholder="ä¾‹å¦‚: ç”Ÿäº§åº“"></div>
            <div class="form-group host-field"><label>ä¸»æœº</label><input type="text" id="dbHost" placeholder="localhost"></div>
            <div class="form-group host-field"><label>ç«¯å£</label><input type="number" id="dbPort" value="3306"></div>
            <div class="form-group host-field"><label>ç”¨æˆ·å</label><input type="text" id="dbUser" placeholder="root"></div>
            <div class="form-group host-field"><label>å¯†ç </label><input type="password" id="dbPass" placeholder="å¯†ç "></div>
            <div class="form-group db-field"><label>æ•°æ®åº“</label><input type="text" id="dbDatabase" placeholder="æ•°æ®åº“å"></div>
            <div class="form-group sqlite-field" style="display:none;"><label>æ–‡ä»¶è·¯å¾„</label><input type="text" id="dbSqlitePath" placeholder="/path/to/db.sqlite"></div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="testAndSave()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘è¿æ¥å¼¹çª— -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘è¿æ¥</div>
            <input type="hidden" id="editConnId">
            <div class="form-group"><label>SQLAlchemy URL</label><div style="display:flex;gap:8px;"><input type="text" id="editDbUrl" readonly style="background:#0f3460;color:#4ade80;font-size:11px;"><button onclick="copyDbUrl()" style="background:#0f3460;border:none;border-radius:8px;color:#ccc;cursor:pointer;padding:0 12px;">å¤åˆ¶</button></div></div>
            <div class="form-group"><label>åç§°</label><input type="text" id="editDbName"></div>
            <div class="form-group host-field"><label>ä¸»æœº</label><input type="text" id="editDbHost"></div>
            <div class="form-group host-field"><label>ç«¯å£</label><input type="number" id="editDbPort"></div>
            <div class="form-group host-field"><label>ç”¨æˆ·å</label><input type="text" id="editDbUser"></div>
            <div class="form-group host-field"><label>å¯†ç </label><input type="password" id="editDbPass" placeholder="ç•™ç©ºä¿æŒåŸå¯†ç "></div>
            <div class="form-group db-field"><label>æ•°æ®åº“</label><input type="text" id="editDbDatabase"></div>
            <div class="form-group sqlite-field" style="display:none;"><label>æ–‡ä»¶è·¯å¾„</label><input type="text" id="editDbSqlitePath"></div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="saveEditConnection()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm å¼¹çª— -->
    <div id="confirmBackdrop" class="modal" onclick="closeConfirmModal()" style="display:none;background:rgba(0,0,0,0.5);">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width:320px;">
            <div class="modal-title" id="confirmTitle">ç¡®è®¤</div>
            <div id="confirmMessage" style="color:#888;margin-bottom:20px;"></div>
            <div style="display:flex;gap:12px;justify-content:flex-end;">
                <button onclick="closeConfirmModal()" style="padding:10px 16px;background:#0f3460;border:none;border-radius:8px;color:#ccc;cursor:pointer;">å–æ¶ˆ</button>
                <button id="confirmBtn" onclick="performConfirm()" style="padding:10px 16px;border:none;border-radius:8px;color:#fff;cursor:pointer;">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <script>
        const $ = id => document.getElementById(id);
        let connections = [], currentConn = null, currentDb = null, currentTable = null;
        let allResults = [], currentPage = 1, totalPages = 1, pageSize = 200;
        let __confirmCallback = null;
        
        const ENGINE_CONFIG = {
            mysql: { port: 3306, icon: 'ğŸ¬' }, postgresql: { port: 5432, icon: 'ğŸ˜' },
            sqlite: { port: 0, icon: 'ğŸ“„' }, mariadb: { port: 3306, icon: 'ğŸ¬' },
            oracle: { port: 1521, icon: 'ğŸ”´' }, mssql: { port: 1433, icon: 'ğŸªŸ' }
        };
        
        // åŠ è½½æ ‘æ•°æ®
        async function loadTree() {
            $('dbTree').innerHTML = '<div class="tree-loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const r = await fetch('/api/db/tree');
                const data = await r.json();
                if (data.success) {
                    renderTree(data.data || []);
                } else {
                    $('dbTree').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>';
                }
            } catch (e) {
                $('dbTree').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // æ¸²æŸ“æ ‘
        function renderTree(treeData) {
            window.dbTreeData = treeData; // ä¿å­˜ä¾›è‡ªåŠ¨è¡¥å…¨ä½¿ç”¨
            updateAutocompleteData(); // æ›´æ–°è¡¨åˆ—è¡¨
            let html = '<div class="tree">';
            treeData.forEach(conn => {
                html += renderTreeNode(conn, 'conn', null);
            });
            html += '</div>';
            $('dbTree').innerHTML = html || '<div class="results-empty">æš‚æ— è¿æ¥</div>';
        }
        
        function renderTreeNode(node, type, parentConnId) {
            const id = type === 'conn' ? node.id : node.name;
            const connId = type === 'conn' ? node.id : parentConnId;
            const label = type === 'conn' ? node.name : node.name;
            const icon = type === 'conn' ? (ENGINE_CONFIG[node.engine || 'mysql']?.icon || 'ğŸ—„ï¸') : (type === 'db' ? 'ğŸ“' : 'ğŸ“‹');
            const hasChildren = node.children && node.children.length > 0 && type !== 'table';
            const expanded = type === 'conn';
            const isToggleable = hasChildren;
            
            let html = `<div class="tree-node" data-type="${type}" data-id="${id}" data-connid="${connId}" data-db="${type === 'conn' ? node.database : (type === 'db' ? node.name : parentConnId)}">
                <div class="tree-node-content" onclick="onNodeClick(this, '${type}', '${id}', '${type === 'db' ? node.name : (type === 'table' ? parentConnId : node.database)}')">
                    ${type === 'table' ? '' : `<span class="tree-toggle ${expanded ? 'expanded' : ''}" onclick="event.stopPropagation();toggleNode(this)">â–¶</span>`}
                    <span class="tree-icon">${icon}</span>
                    <span class="tree-label">${label}</span>
                    ${type === 'conn' ? `<div class="tree-actions">
                        <button onclick="event.stopPropagation();openEditModal('${id}')">ç¼–è¾‘</button>
                        <button onclick="event.stopPropagation();deleteConnection('${id}')">åˆ é™¤</button>
                    </div>` : ''}
                </div>`;
            
            if (hasChildren) {
                html += `<div class="tree-children ${expanded ? '' : 'collapsed'}">`;
                node.children.forEach(child => {
                    const childType = type === 'conn' ? 'db' : (child.children && child.children.length > 0 ? 'db' : 'table');
                    html += renderTreeNode(child, childType, connId);
                });
                html += '</div>';
            }
            html += '</div>';
            return html;
        }
        
        function toggleNode(el) {
            el.classList.toggle('expanded');
            const children = el.parentElement.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('collapsed');
            }
        }
        
        async function onNodeClick(el, type, id, dbName) {
            // ç‚¹å‡»å¯å±•å¼€çš„èŠ‚ç‚¹æ—¶ï¼Œtoggleå±•å¼€/æŠ˜å 
            const nodeEl = el.closest('.tree-node');
            const hasChildren = nodeEl.querySelector('.tree-children');
            if (hasChildren && type !== 'table') {
                const toggle = nodeEl.querySelector('.tree-toggle');
                if (toggle) {
                    toggleNode(toggle);
                    return; // ä¸æ‰§è¡ŒæŸ¥è¯¢
                }
            }
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tree-node-content').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            if (type === 'table') {
                // ç‚¹å‡»è¡¨
                const connId = nodeEl.dataset.connid;
                const conn = connections.find(c => c.id === connId);
                if (!conn) { console.error('Connection not found:', connId); return; }
                currentConn = conn;
                currentDb = dbName;
                currentTable = id;
                updateBreadcrumb();
                updateAutocompleteData();
                
                // å…³é—­ä¾§è¾¹æ 
                closeDrawer();
                
                // æ‰§è¡ŒæŸ¥è¯¢ï¼ˆä¸è‡ªåŠ¨å±•å¼€ç¼–è¾‘å™¨ï¼‰
                const sql = `SELECT * FROM \`${id}\` LIMIT 200`;
                $('sqlEditor').value = sql;
                executeQuery();
            }
        }
        
        function updateBreadcrumb() {
            let html = '';
            if (currentConn) html += `<span>${currentConn.name}</span>`;
            if (currentDb) html += ` / <span>${currentDb}</span>`;
            if (currentTable) html += ` / <span>${currentTable}</span>`;
            $('breadcrumb').innerHTML = html || '<span>æœªé€‰æ‹©</span>';
        }
        
        window.toggleDrawer = function() { $('drawer').classList.toggle('open'); $('drawerBackdrop').classList.toggle('show'); };
        window.closeDrawer = function() { $('drawer').classList.remove('open'); $('drawerBackdrop').classList.remove('show'); };
        
        // SQLå†å²
        const FIXED_SQLS = [
            { sql: 'SHOW TABLES', label: 'Tables' },
            { sql: 'SHOW PROCESSLIST', label: 'Process' },
            { sql: 'DESCRIBE `table_name`', label: 'Desc' },
            { sql: 'SELECT COUNT(*) FROM `table_name`', label: 'Count' },
            { sql: 'SHOW STATUS', label: 'Status' }
        ];
        
        function openSqlHistory() {
            renderSqlHistory();
            $('historyDrawer').classList.add('open');
            $('historyBackdrop').classList.add('show');
        }
        
        function closeSqlHistory() {
            $('historyDrawer').classList.remove('open');
            $('historyBackdrop').classList.remove('show');
        }
        
        function renderSqlHistory() {
            const fixedHtml = FIXED_SQLS.map(s => 
                `<div class="sql-history-item" onclick="useHistorySql('${s.sql.replace(/`/g, '\\`')}')">
                    <div class="sql-text">${s.sql}</div>
                </div>`
            ).join('');
            
            const rawHistory = localStorage.getItem('db_sql_history') || '[]';
            let history = [];
            try {
                history = JSON.parse(rawHistory);
            } catch (e) {}
            
            const historyHtml = history.length ? history.map(s => {
                if (!s || !s.sql) return '';
                return `<div class="sql-history-item" onclick="useHistorySql('${s.sql.replace(/'/g, "\\'").replace(/\n/g, ' ')}')">
                    <div class="sql-text">${s.sql.length > 50 ? s.sql.substring(0, 50) + '...' : s.sql}</div>
                    <div class="sql-time">${new Date(s.time).toLocaleString()}</div>
                </div>`;
            }).join('') : '<div style="padding:20px;text-align:center;color:#666;font-size:12px;">æš‚æ— å†å²è®°å½•</div>';
            
            $('sqlHistoryList').innerHTML = `
                <div class="history-section-title">å¸¸ç”¨ SQL</div>
                ${fixedHtml}
                ${history.length ? '<div class="history-divider"></div><div class="history-section-title">å†å²è®°å½•</div>' : ''}
                ${historyHtml}
            `;
        }
        
        function useHistorySql(sql) {
            $('sqlEditor').value = sql;
            closeSqlHistory();
            toggleSqlEditor();
            executeQuery();
        }

        let __sqlHistoryNavIndex = -1;

        function __getSqlHistoryNavList() {
            const rawHistory = localStorage.getItem('db_sql_history') || '[]';
            let history = [];
            try {
                history = JSON.parse(rawHistory);
            } catch (e) {
                history = [];
            }
            return (Array.isArray(history) ? history : [])
                .map(h => (h && h.sql) || '')
                .filter(s => typeof s === 'string' && s.trim());
        }

        function __ensureSqlEditorOpen() {
            const panel = $('sqlEditorPanel');
            if (panel && !panel.classList.contains('open')) toggleSqlEditor();
        }

        function __setSqlEditorValue(sql) {
            __ensureSqlEditorOpen();
            const ta = $('sqlEditor');
            if (!ta) return;
            ta.value = sql || '';
            try {
                ta.selectionStart = ta.selectionEnd = ta.value.length;
            } catch (e) {}
            if (typeof closeAutocomplete === 'function') closeAutocomplete();
            ta.focus();
        }

        function sqlHistoryPrev() {
            const list = __getSqlHistoryNavList();
            if (!list.length) {
                showStatus('æš‚æ— å†å²è®°å½•', true);
                return;
            }

            const current = String($('sqlEditor')?.value || '').trim();
            const found = current ? list.indexOf(current) : -1;
            if (found >= 0) __sqlHistoryNavIndex = found;

            if (__sqlHistoryNavIndex < 0) __sqlHistoryNavIndex = 0;
            else if (__sqlHistoryNavIndex < list.length - 1) __sqlHistoryNavIndex += 1;

            __setSqlEditorValue(list[__sqlHistoryNavIndex] || '');
        }

        function sqlHistoryNext() {
            const list = __getSqlHistoryNavList();
            if (!list.length) {
                showStatus('æš‚æ— å†å²è®°å½•', true);
                return;
            }

            const current = String($('sqlEditor')?.value || '').trim();
            const found = current ? list.indexOf(current) : -1;
            if (found >= 0) __sqlHistoryNavIndex = found;

            if (__sqlHistoryNavIndex < 0) __sqlHistoryNavIndex = 0;
            else if (__sqlHistoryNavIndex > 0) __sqlHistoryNavIndex -= 1;

            __setSqlEditorValue(list[__sqlHistoryNavIndex] || '');
        }
        
        function toggleSqlEditor() { $('sqlEditorPanel').classList.toggle('open'); $('sqlToggle').classList.toggle('open'); }
        function clearEditor() { $('sqlEditor').value = ''; closeAutocomplete(); }
        
        // ========== SQL è‡ªåŠ¨è¡¥å…¨ ==========
        const SQL_KEYWORDS = [
            'SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'NOT', 'IN', 'LIKE', 'BETWEEN',
            'JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'INNER JOIN', 'OUTER JOIN', 'ON',
            'ORDER BY', 'ASC', 'DESC', 'LIMIT', 'OFFSET',
            'GROUP BY', 'HAVING', 'DISTINCT', 'COUNT', 'SUM', 'AVG', 'MIN', 'MAX',
            'INSERT INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE FROM',
            'CREATE TABLE', 'DROP TABLE', 'ALTER TABLE', 'ADD COLUMN', 'MODIFY COLUMN',
            'INDEX', 'UNIQUE', 'PRIMARY KEY', 'FOREIGN KEY',
            'AS', 'NULL', 'IS NULL', 'IS NOT NULL', 'EXISTS', 'ALL', 'ANY',
            'UNION', 'UNION ALL', 'INTERSECT', 'EXCEPT',
            'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'AS', 'CAST', 'COALESCE', 'IFNULL', 'NULLIF'
        ];
        const SQL_FUNCTIONS = [
            'NOW()', 'CURDATE()', 'CURTIME()', 'DATE()', 'TIME()', 'YEAR()', 'MONTH()', 'DAY()', 'HOUR()', 'MINUTE()', 'SECOND()',
            'DATE_FORMAT()', 'DATE_ADD()', 'DATE_SUB()', 'DATEDIFF()', 'TIMESTAMPDIFF()',
            'CONCAT()', 'CONCAT_WS()', 'SUBSTRING()', 'LEFT()', 'RIGHT()', 'LENGTH()', 'TRIM()', 'UPPER()', 'LOWER()',
            'REPLACE()', 'INSERT()', 'INSTR()', 'LOCATE()',
            'ROUND()', 'FLOOR()', 'CEIL()', 'ABS()', 'SQRT()', 'POW()', 'MOD()',
            'IFNULL()', 'COALESCE()', 'NULLIF()', 'IF()', 'CASE WHEN()',
            'RAND()', 'UUID()', 'LAST_INSERT_ID()', 'ROW_COUNT()',
            'COUNT()', 'SUM()', 'AVG()', 'MIN()', 'MAX()', 'GROUP_CONCAT()'
        ];
        let _acTableNames = [], _acColumns = {};
        let _acHistory = JSON.parse(localStorage.getItem('db_sql_history') || '[]').map(h => (h && h.sql) || h).filter(h => h && typeof h === 'string').filter((v, i, a) => a.indexOf(v) === i);
        let _acSelected = -1, _acItems = [];
        
        function updateAutocompleteData() {
            // æ›´æ–°è¡¨ååˆ—è¡¨
            if (window.dbTreeData) {
                _acTableNames = [];
                const findTables = nodes => {
                    nodes.children?.forEach(c => {
                        if (c.children) findTables(c);
                        else _acTableNames.push(c.name);
                    });
                };
                dbTreeData.forEach(findTables);
            }
        }
        
        async function loadTableColumns(tableName) {
            if (!currentConn || !tableName) return Promise.resolve([]);
            if (_acColumns[tableName]) return Promise.resolve(_acColumns[tableName]);
            try {
                const r = await fetch(`/api/db/${currentConn.id}/table/${encodeURIComponent(tableName)}/columns`);
                const d = await r.json();
                _acColumns[tableName] = d.data?.columns || [];
                return Promise.resolve(_acColumns[tableName]);
            } catch(e) { _acColumns[tableName] = []; return Promise.resolve([]); }
        }

        function getLastPartTableName(raw) {
            var s = String(raw || '').trim();
            if (!s) return '';
            s = s.replace(/`/g, '');
            var parts = s.split('.');
            return parts[parts.length - 1] || '';
        }

        function extractTableRefs(sqlBeforeCursor) {
            var text = String(sqlBeforeCursor || '');
            var refs = [];
            var re = /\b(from|join)\s+`?([\w.]+)`?(?:\s+(?:as\s+)?`?(\w+)`?)?/ig;
            var m;
            while ((m = re.exec(text))) {
                var tableRaw = m[2] || '';
                var alias = m[3] || '';
                var tableName = getLastPartTableName(tableRaw);
                if (!tableName) continue;
                refs.push({ table: tableName, alias: alias });
            }
            return refs;
        }

        function getAliasMap(sqlBeforeCursor) {
            var refs = extractTableRefs(sqlBeforeCursor);
            var map = {};
            refs.forEach(function(r) {
                map[r.table] = r.table;
                if (r.alias) map[r.alias] = r.table;
            });
            return map;
        }

        function getPreferredTable(sqlBeforeCursor) {
            var refs = extractTableRefs(sqlBeforeCursor);
            if (!refs.length) return '';
            return refs[refs.length - 1].table || '';
        }
        
        function showAutocomplete(text, cursorPos) {
            // è·å–å…‰æ ‡å‰æœ€åä¸€ä¸ªå•è¯
            const before = text.substring(0, cursorPos);
            const match = before.match(/[\w`*.]+$/);
            if (!match || match[0].length < 1) { closeAutocomplete(); return; }
            const rawToken = match[0].replace(/`/g, '');
            const tokenUpper = rawToken.toUpperCase();
            const isQualified = rawToken.indexOf('.') >= 0;
            const aliasMap = getAliasMap(before);
            
            // ç”Ÿæˆå€™é€‰åˆ—è¡¨
            const items = [];
            if (isQualified) {
                var lastDot = rawToken.lastIndexOf('.');
                var qualifier = rawToken.slice(0, lastDot);
                var prefix = rawToken.slice(lastDot + 1);
                var qualifierUpper = qualifier.toUpperCase();
                var prefixUpper = prefix.toUpperCase();
                var tableForCols = aliasMap[qualifier] || getLastPartTableName(qualifier);
                if (!tableForCols) { closeAutocomplete(); return; }
                var cols = _acColumns[tableForCols] || [];
                if (!cols.length) {
                    loadTableColumns(tableForCols).then(function() {
                        var newCols = (_acColumns[tableForCols] || []).filter(function(c) { return c && c.toUpperCase().startsWith(prefixUpper); });
                        newCols.forEach(function(c) { items.push({ text: qualifier + '.' + c, type: 'col' }); });
                        if (!items.length) { closeAutocomplete(); return; }
                        _acItems = items.slice(0, 10);
                        _acSelected = 0;
                        renderAutocomplete();
                    });
                    return;
                }
                cols.filter(function(c) { return c && c.toUpperCase().startsWith(prefixUpper); })
                    .forEach(function(c) { items.push({ text: qualifier + '.' + c, type: 'col' }); });
                if (!items.length) { closeAutocomplete(); return; }
                _acItems = items.slice(0, 10);
                _acSelected = 0;
                renderAutocomplete();
                return;
            }

            // å…³é”®å­—
            SQL_KEYWORDS.filter(k => k && k.startsWith(tokenUpper) && k !== tokenUpper).forEach(k => items.push({text: k, type: 'key'}));
            // å‡½æ•°
            SQL_FUNCTIONS.filter(f => f && f.startsWith(tokenUpper) && f !== tokenUpper).forEach(f => items.push({text: f, type: 'func'}));
            // è¡¨å
            _acTableNames.filter(t => t && t.toUpperCase().startsWith(tokenUpper) && t.toUpperCase() !== tokenUpper).forEach(t => items.push({text: t, type: 'tbl'}));
            // å­—æ®µï¼šä¼˜å…ˆä½¿ç”¨æœ€åä¸€ä¸ª FROM/JOIN è¡¨ï¼ˆæ”¯æŒåˆ«ååç»­é€šè¿‡ t. è§¦å‘ï¼‰
            var preferredTbl = getPreferredTable(before);
            if (preferredTbl) {
                var cols2 = _acColumns[preferredTbl] || [];
                if (!cols2.length) {
                    loadTableColumns(preferredTbl).then(function() {
                        var newCols = (_acColumns[preferredTbl] || []).filter(function(c) { return c && c.toUpperCase().startsWith(tokenUpper); });
                        newCols.forEach(function(c) { items.push({ text: c, type: 'col' }); });
                        if (!items.length) { closeAutocomplete(); return; }
                        _acItems = items.slice(0, 10);
                        _acSelected = 0;
                        renderAutocomplete();
                    });
                    return;
                }
                cols2.filter(function(c) { return c && c.toUpperCase().startsWith(tokenUpper); }).forEach(function(c) { items.push({ text: c, type: 'col' }); });
            }
            // å†å²
            _acHistory.filter(h => h && h.toUpperCase().startsWith(tokenUpper)).slice(0, 5).forEach(h => items.push({text: h, type: 'his'}));
            
            if (items.length === 0) { closeAutocomplete(); return; }
            
            _acItems = items.slice(0, 10);
            _acSelected = 0;
            renderAutocomplete();
        }
        
        function renderAutocomplete() {
            const el = $('sqlAutocomplete');
            if (!_acItems.length) { el.style.display = 'none'; return; }
            el.innerHTML = _acItems.map((item, i) => 
                `<div class="sql-autocomplete-item ${i === _acSelected ? 'selected' : ''}" data-index="${i}">
                    <span class="type-tag ${item.type}">${item.type.toUpperCase()}</span>
                    <span>${item.text}</span>
                </div>`
            ).join('');
            el.style.display = 'block';
            
            // ç‚¹å‡»é€‰æ‹©
            el.querySelectorAll('.sql-autocomplete-item').forEach((div, i) => {
                div.onclick = () => selectAutocomplete(i);
            });
        }
        
        function selectAutocomplete(index) {
            const item = _acItems[index];
            if (!item) return;
            const textarea = $('sqlEditor');
            const text = textarea.value;
            const pos = textarea.selectionStart;
            const before = text.substring(0, pos);
            const wordMatch = before.match(/[\w`*.]+$/);
            if (wordMatch) {
                const start = pos - wordMatch[0].length;
                textarea.value = text.substring(0, start) + item.text + text.substring(pos);
                textarea.selectionStart = textarea.selectionEnd = start + item.text.length;
            }
            closeAutocomplete();
            textarea.focus();
        }
        
        function closeAutocomplete() {
            $('sqlAutocomplete').style.display = 'none';
            _acItems = [];
            _acSelected = -1;
        }
        
        function initAutocomplete() {
            const textarea = $('sqlEditor');
            textarea.addEventListener('input', e => {
                showAutocomplete(e.target.value, e.target.selectionStart);
            });
            textarea.addEventListener('keydown', e => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (_acItems.length) {
                        _acSelected = (_acSelected + 1) % _acItems.length;
                        renderAutocomplete();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (_acItems.length) {
                        _acSelected = (_acSelected - 1 + _acItems.length) % _acItems.length;
                        renderAutocomplete();
                    }
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    if (_acItems.length && $('sqlAutocomplete').style.display !== 'none') {
                        e.preventDefault();
                        selectAutocomplete(_acSelected);
                    }
                } else if (e.key === 'Escape') {
                    closeAutocomplete();
                }
            });
            textarea.addEventListener('blur', () => {
                setTimeout(closeAutocomplete, 200);
            });
        }
        
        async function executeQuery() {
            const sql = $('sqlEditor').value.trim();
            if (!sql) return;
            $('resultsContent').innerHTML = '<div class="loading"><div class="spinner"></div>æ‰§è¡Œä¸­...</div>';
            
            try {
                const r = await fetch('/api/db/execute', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ connection: currentConn.id, query: sql })
                });
                const data = await r.json();
                if (data.success) {
                    allResults = data.data?.rows || [];
                    currentPage = 1;
                    totalPages = Math.ceil(allResults.length / pageSize);
                    renderResults(data.data.headers || [], getPageData());
                    showStatus(`æˆåŠŸ ${allResults.length} è¡Œ`, false);
                    $('resultsToolbar').style.display = allResults.length > pageSize ? 'flex' : 'none';
                    
                    // ä¿å­˜åˆ°å†å²
                    if (sql.toLowerCase().startsWith('select') || sql.toLowerCase().startsWith('show') || sql.toLowerCase().startsWith('describe')) {
                        const history = JSON.parse(localStorage.getItem('db_sql_history') || '[]');
                        const filtered = history.filter(h => h.sql !== sql);
                        filtered.unshift({ sql: sql, time: Date.now() });
                        localStorage.setItem('db_sql_history', JSON.stringify(filtered.slice(0, 50)));
                    }
                } else {
                    showStatus('å¤±è´¥: ' + data.message, true);
                    $('resultsContent').innerHTML = `<div class="results-empty" style="color:#ef4444;">${data.message}</div>`;
                    $('resultsToolbar').style.display = 'none';
                }
            } catch (e) {
                showStatus('å¤±è´¥: ' + e.message, true);
                $('resultsContent').innerHTML = `<div class="results-empty" style="color:#ef4444;">${e.message}</div>`;
            }
        }
        
        function getPageData() {
            const start = (currentPage - 1) * pageSize;
            return allResults.slice(start, start + pageSize);
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            const headers = $('resultsContent').querySelectorAll('thead th');
            const headerArr = Array.from(headers).map(th => th.textContent);
            renderResults(headerArr, getPageData());
        }
        
        function renderResults(headers, rows) {
            $('resultsContent').innerHTML = rows.length === 0 
                ? '<div class="results-empty">æ— æ•°æ®</div>' 
                : `<div class="data-table-wrapper"><table class="data-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.map((row, ri) => `<tr>${row.map((cell, ci) => `<td onclick="editCell(this, ${ri}, ${ci})" data-row="${ri}" data-col="${ci}">${cell||''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            $('pageInfo').textContent = `${currentPage} / ${totalPages}`;
        }
        
        // å•å…ƒæ ¼ç¼–è¾‘
        function editCell(td, rowIdx, colIdx) {
            if (td.querySelector('input')) return; // å·²åœ¨ç¼–è¾‘
            const value = td.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            input.style.cssText = 'width:100%;border:none;background:#fff;color:#333;padding:2px 4px;border-radius:3px;';
            input.onblur = () => submitCellEdit(td, rowIdx, colIdx, input.value);
            input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { td.textContent = value; } };
            td.textContent = '';
            td.appendChild(input);
            input.focus();
            input.select();
        }
        
        function submitCellEdit(td, rowIdx, colIdx, newValue) {
            const oldValue = allResults[rowIdx][colIdx];
            if (oldValue === newValue) { td.textContent = oldValue; return; }
            
            if (!currentTable) { showStatus('æ— æ³•æ›´æ–°ï¼šæœªé€‰æ‹©è¡¨', true); return; }
            
            // æ„å»º UPDATE è¯­å¥
            const headers = $('resultsContent').querySelectorAll('thead th');
            const colName = headers[colIdx].textContent;
            const sql = `UPDATE \`${currentTable}\` SET \`${colName}\` = ${newValue === '' ? 'NULL' : typeof newValue === 'number' ? newValue : `'${newValue.replace(/'/g, "''")}'`} WHERE `;
            
            // é€šè¿‡ä¸»é”®å®šä½ï¼ˆç®€å•å¤„ç†ï¼šå‡è®¾æ‰€æœ‰å­—æ®µéƒ½å‚ä¸å®šä½ï¼‰
            const pkParts = [];
            headers.forEach((h, i) => pkParts.push(`\`${h.textContent}\` = ${typeof allResults[rowIdx][i] === 'number' ? allResults[rowIdx][i] : `'${String(allResults[rowIdx][i] || '').replace(/'/g, "''")}'`}`));
            
            fetch('/api/db/execute', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ connection: currentConn.id, query: sql + pkParts.join(' AND ') })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    allResults[rowIdx][colIdx] = newValue;
                    td.textContent = newValue;
                    showStatus('æ›´æ–°æˆåŠŸ', false);
                } else {
                    td.textContent = oldValue;
                    showStatus('æ›´æ–°å¤±è´¥: ' + data.message, true);
                }
            }).catch(e => { td.textContent = oldValue; showStatus('æ›´æ–°å¤±è´¥: ' + e.message, true); });
        }
        
        function quickQuery(sql) {
            if (!currentConn) { showStatus('è¯·å…ˆé€‰æ‹©è¡¨', true); return; }
            $('sqlEditor').value = sql;
            $('sqlEditorPanel').classList.add('open');
            $('sqlToggle').classList.add('open');
            executeQuery();
        }
        
        function exportData(format) {
            if (allResults.length === 0) { showStatus('æ— å¯å¯¼å‡ºæ•°æ®', true); return; }
            const headers = $('resultsContent').querySelectorAll('thead th');
            const headerArr = Array.from(headers).map(th => th.textContent);
            let content = '', filename = `export_${Date.now()}`;
            
            if (format === 'csv') {
                content = headerArr.map(h => `"${h}"`).join(',') + '\n';
                allResults.forEach(row => content += row.map(cell => `"${(cell||'').replace(/"/g, '""')}"`).join(',') + '\n');
                filename += '.csv';
            } else if (format === 'xls') {
                content = '<html><meta charset="utf-8"><table border="1"><tr>' + headerArr.map(h => `<th style="background:#eee;padding:4px;">${h}</th>`).join('') + '</tr>' + allResults.map(row => '<tr>' + row.map(cell => `<td style="padding:4px;">${cell||''}</td>`).join('') + '</tr>').join('') + '</table></html>';
                filename += '.xls';
            } else if (format === 'sql') {
                const table = currentTable || 'table_name';
                content = `-- ${table}\n`;
                allResults.forEach(row => {
                    const vals = row.map(cell => cell === null ? 'NULL' : typeof cell === 'number' ? cell : `'${String(cell).replace(/'/g, "''")}'`).join(', ');
                    content += `INSERT INTO \`${table}\` VALUES (${vals});\n`;
                });
                filename += '.sql';
            }
            const blob = new Blob([content], {type: format === 'csv' ? 'text/csv' : 'application/vnd.ms-excel'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(blob);
            showStatus(`å·²å¯¼å‡º ${allResults.length} è¡Œ`, false);
        }
        
        function switchResultsTab(tab) {
            document.querySelectorAll('.results-tab').forEach(t => t.classList.remove('active'));
            $('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            $('resultsContent').style.display = tab === 'results' ? 'block' : 'none';
            $('schemaPanel').style.display = tab === 'schema' ? 'block' : 'none';
            if (tab === 'schema' && currentTable) loadTableSchema();
        }
        
        async function loadTableSchema() {
            if (!currentConn || !currentTable) return;
            $('schemaPanel').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const r = await fetch(`/api/db/${currentConn.id}/table/${currentTable}/schema`);
                const data = await r.json();
                if (data.success) {
                    const cols = data.data?.columns || [];
                    $('schemaPanel').innerHTML = cols.length ? `<table class="data-table"><thead><tr><th>åˆ—å</th><th>ç±»å‹</th><th>å¯ç©º</th><th>é”®</th></tr></thead><tbody>` + 
                        cols.map(c => `<tr><td>${c.field}</td><td>${c.type}</td><td>${c.null === 'YES' ? 'âœ“' : 'âœ—'}</td><td>${c.key || ''}</td></tr>`).join('') + '</tbody></table>' : '<div class="results-empty">æ— ç»“æ„</div>';
                }
            } catch (e) { $('schemaPanel').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>'; }
        }
        
        function showStatus(msg, error) { $('statusBar').innerHTML = `<span class="${error ? 'error' : 'success'}">${msg}</span>`; }
        
        function showConfirm(title, msg, onConfirm, danger) {
            $('confirmTitle').textContent = title;
            $('confirmMessage').textContent = msg;
            __confirmCallback = onConfirm;
            $('confirmBtn').className = danger ? 'confirm' : '';
            $('confirmBtn').textContent = danger ? 'åˆ é™¤' : 'ç¡®è®¤';
            $('confirmBackdrop').style.display = 'flex';
        }
        function performConfirm() { if (__confirmCallback) __confirmCallback(); closeConfirmModal(); }
        function closeConfirmModal() { $('confirmBackdrop').style.display = 'none'; }
        
        function copyToClipboard(text) {
            if (typeof clipboard !== 'undefined' && clipboard.copy) clipboard.copy(text).then(() => showStatus('å·²å¤åˆ¶', false)).catch(() => fallbackCopy(text));
            else fallbackCopy(text);
        }
        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); showStatus('å·²å¤åˆ¶', false); } catch (e) { showStatus('å¤åˆ¶å¤±è´¥', true); }
            document.body.removeChild(ta);
        }
        
        // æ·»åŠ è¿æ¥
        function openAddModal() {
            $('dbEngine').value = 'mysql'; $('dbName').value = ''; $('dbHost').value = ''; $('dbPort').value = '3306';
            $('dbUser').value = ''; $('dbPass').value = ''; $('dbDatabase').value = ''; $('dbSqlitePath').value = '';
            $('dbUrl').value = '';
            updateEngineFields();
            $('addModal').classList.add('show');
        }
        function closeAddModal() { $('addModal').classList.remove('show'); }
        function updateEngineFields() {
            const eng = $('dbEngine').value;
            document.querySelectorAll('.host-field').forEach(el => el.style.display = eng === 'sqlite' ? 'none' : 'block');
            document.querySelectorAll('.sqlite-field').forEach(el => el.style.display = eng === 'sqlite' ? 'block' : 'none');
        }

        function normalizeEngineFromScheme(scheme) {
            var s = String(scheme || '').toLowerCase();
            if (!s) return '';
            var base = s.split('+')[0];
            if (base === 'postgres') base = 'postgresql';
            if (base === 'sqlserver') base = 'mssql';
            if (base === 'mssql') base = 'mssql';
            if (base === 'mysql') base = 'mysql';
            if (base === 'mariadb') base = 'mariadb';
            if (base === 'sqlite') base = 'sqlite';
            if (base === 'oracle') base = 'oracle';
            return base;
        }

        function parseDbUrl(raw) {
            var input = String(raw || '').trim();
            if (!input) return null;
            if (input.toLowerCase().startsWith('sqlite:')) {
                var m4 = input.match(/^sqlite:(\/\/\/\/)(.+)$/i);
                var m3 = input.match(/^sqlite:(\/\/\/)(.+)$/i);
                var m2 = input.match(/^sqlite:(\/\/)(.+)$/i);
                var rest = m4 ? ('/' + m4[2]) : (m3 ? m3[2] : (m2 ? m2[2] : input.replace(/^sqlite:/i, '')));
                var path = '';
                try { path = decodeURIComponent(rest); } catch (e) { path = rest; }
                return { engine: 'sqlite', sqlitePath: path };
            }

            var u = null;
            try { u = new URL(input); } catch (e) { return null; }
            var engine = normalizeEngineFromScheme((u && u.protocol ? u.protocol.replace(':', '') : ''));
            if (!engine) return null;
            var database = '';
            try { database = decodeURIComponent(String(u.pathname || '').replace(/^\/+/, '')); } catch (e) { database = String(u.pathname || '').replace(/^\/+/, ''); }
            var port = u.port ? String(u.port) : '';
            return {
                engine: engine,
                host: u.hostname || '',
                port: port,
                user: u.username || '',
                password: u.password || '',
                database: database
            };
        }

        function applyDbUrl(showErr) {
            var url = $('dbUrl') ? $('dbUrl').value : '';
            var parsed = parseDbUrl(url);
            if (!parsed) {
                if (showErr) showStatus('URL è§£æå¤±è´¥', true);
                return;
            }

            var eng = parsed.engine || '';
            if (eng && $('dbEngine')) $('dbEngine').value = eng;
            updateEngineFields();

            if (eng === 'sqlite') {
                if ($('dbSqlitePath')) $('dbSqlitePath').value = parsed.sqlitePath || '';
                if ($('dbPort')) $('dbPort').value = '0';
                return;
            }

            if ($('dbHost')) $('dbHost').value = parsed.host || $('dbHost').value;
            if ($('dbUser')) $('dbUser').value = parsed.user || $('dbUser').value;
            if ($('dbPass')) $('dbPass').value = parsed.password || $('dbPass').value;
            if ($('dbDatabase')) $('dbDatabase').value = parsed.database || $('dbDatabase').value;
            if ($('dbPort')) $('dbPort').value = parsed.port || String(ENGINE_CONFIG[eng]?.port || $('dbPort').value || '');
        }
        async function testAndSave() {
            const eng = $('dbEngine').value;
            const data = {name:$('dbName').value, engine:eng, host:eng==='sqlite'?'':$('dbHost').value, port:String($('dbPort').value||ENGINE_CONFIG[eng]?.port||3306), 
                user:eng==='sqlite'?'':$('dbUser').value, password:eng==='sqlite'?'':$('dbPass').value, database:eng==='sqlite'?$('dbSqlitePath').value:$('dbDatabase').value};
            if (!data.name) { showStatus('è¯·å¡«å†™åç§°', true); return; }
            if (eng !== 'sqlite' && (!data.host || !data.user)) { showStatus('è¯·å¡«å†™å¿…è¦ä¿¡æ¯', true); return; }
            try {
                await fetch('/api/db/connect', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                closeAddModal(); loadTree(); loadConnections(); showStatus('å·²ä¿å­˜', false);
            } catch (e) { showStatus('ä¿å­˜å¤±è´¥: ' + e.message, true); }
        }
        
        // ç¼–è¾‘è¿æ¥
        async function openEditModal(id) {
            const conn = connections.find(c => c.id === id);
            if (!conn) return;
            $('editConnId').value = id; $('editDbName').value = conn.name || '';
            $('editDbHost').value = conn.host || ''; $('editDbPort').value = conn.port || '';
            $('editDbUser').value = conn.user || ''; $('editDbPass').value = '';
            $('editDbDatabase').value = conn.database || ''; $('editDbSqlitePath').value = conn.engine === 'sqlite' ? conn.database : '';
            const url = `${conn.engine || 'mysql'}://${conn.user||''}:***@${conn.host||''}:${conn.port||3306}/${conn.database||''}`;
            $('editDbUrl').value = url;
            $('editModal').classList.add('show');
        }
        function closeEditModal() { $('editModal').classList.remove('show'); }
        function copyDbUrl() { copyToClipboard($('editDbUrl').value); }
        async function saveEditConnection() {
            const id = $('editConnId').value;
            const eng = connections.find(c => c.id === id)?.engine || 'mysql';
            const data = {name:$('editDbName').value, engine:eng, host:$('editDbHost').value, port:String($('editDbPort').value), user:$('editDbUser').value, password:$('editDbPass').value, database:$('editDbDatabase').value};
            try {
                await fetch(`/api/db/connection/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                closeEditModal(); loadTree(); loadConnections(); showStatus('å·²æ›´æ–°', false);
            } catch (e) { showStatus('ä¿å­˜å¤±è´¥', true); }
        }
        
        function deleteConnection(id) {
            showConfirm('åˆ é™¤è¿æ¥', 'ç¡®å®šè¦åˆ é™¤æ­¤è¿æ¥å—ï¼Ÿ', async () => {
                try {
                    await fetch(`/api/db/connections/${id}`, {method:'DELETE'});
                    currentConn = null; currentDb = null; currentTable = null;
                    loadTree(); loadConnections(); updateBreadcrumb(); showStatus('å·²åˆ é™¤', false);
                } catch (e) { showStatus('åˆ é™¤å¤±è´¥', true); }
            }, true);
        }
        
        async function loadConnections() {
            const r = await fetch('/api/db/connections');
            const data = await r.json();
            if (data.success) connections = data.data?.connections || [];
        }

        if ($('dbEngine')) $('dbEngine').addEventListener('change', function() { updateEngineFields(); });
        if ($('dbUrl')) {
            $('dbUrl').addEventListener('change', function() { applyDbUrl(false); });
            $('dbUrl').addEventListener('keydown', function(e) { if (e && e.key === 'Enter') { e.preventDefault(); applyDbUrl(false); } });
            $('dbUrl').addEventListener('paste', function() { setTimeout(function() { applyDbUrl(false); }, 0); });
        }
        
        document.addEventListener('keydown', e => { if ((e.ctrlKey||e.metaKey) && e.key==='Enter') executeQuery(); });
        loadConnections().then(loadTree).then(() => { updateAutocompleteData(); initAutocomplete(); });
    </script>
</body>
</html>
