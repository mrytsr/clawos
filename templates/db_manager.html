<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1e1e1e; color: #ccc; }
        
        .toolbar {
            display: flex; align-items: center; gap: 12px; padding: 10px 16px;
            background: #2d2d2d; border-bottom: 1px solid #404040;
        }
        select { min-width: 120px; }
        button {
            padding: 6px 14px; border-radius: 6px; border: none;
            background: #0e639c; color: #fff; font-size: 13px; cursor: pointer;
        }
        button:hover { background: #1177bb; }
        button.secondary { background: #3c3c3c; }
        button.danger { background: #cf222e; }
        
        .main { display: flex; height: calc(100vh - 52px); }
        .sidebar { width: 200px; background: #252526; border-right: 1px solid #404040; overflow: auto; padding: 8px; }
        .conn-item {
            padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .conn-item:hover { background: #3c3c3c; }
        .conn-item.active { background: #0e639c; }
        .conn-icon { font-size: 16px; }
        .conn-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; }
        
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .query-bar { padding: 8px 12px; background: #252526; border-bottom: 1px solid #404040; display: flex; gap: 8px; }
        .query-bar textarea {
            flex: 1; resize: none; border: none; outline: none;
            background: #1e1e1e; color: #ccc; font-family: 'Consolas', monospace;
            font-size: 13px; padding: 8px; border-radius: 6px;
        }
        .results { flex: 1; overflow: auto; padding: 12px; }
        .table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .table th, .table td {
            padding: 8px 12px; border: 1px solid #404040; text-align: left;
        }
        .table th { background: #252526; position: sticky; top: 0; }
        .table tr:nth-child(even) { background: #252526; }
        .empty { text-align: center; padding: 40px; color: #666; }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2d2d2d; border-radius: 12px; padding: 20px; width: 400px; max-width: 90%;
        }
        .modal-title { font-size: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #404040;
            background: #3c3c3c; color: #ccc; font-size: 14px;
        }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        
        .status-bar { padding: 6px 16px; background: #007acc; color: #fff; font-size: 12px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="app">
        <div class="toolbar">
            <select id="connSelect" onchange="connectDB()">
                <option value="">é€‰æ‹©æ•°æ®åº“è¿æ¥...</option>
            </select>
            <button onclick="openAddModal()">+ æ·»åŠ è¿æ¥</button>
            <button class="secondary" onclick="testConnection()">æµ‹è¯•</button>
            <button class="secondary" onclick="refreshDB()">åˆ·æ–°</button>
        </div>
        <div class="main">
            <div class="sidebar" id="sidebar">
                <div class="empty">è¯·æ·»åŠ æ•°æ®åº“è¿æ¥</div>
            </div>
            <div class="content">
                <div class="query-bar">
                    <textarea id="query" placeholder="è¾“å…¥ SQL æŸ¥è¯¢... (Ctrl+Enter æ‰§è¡Œ)" rows="3"></textarea>
                    <button onclick="executeQuery()">æ‰§è¡Œ</button>
                </div>
                <div id="results" class="results">
                    <div class="empty">è¿æ¥æ•°æ®åº“åæ‰§è¡ŒæŸ¥è¯¢</div>
                </div>
            </div>
        </div>
        <div id="statusBar" class="status-bar" style="display:none;"></div>
    </div>

    <!-- æ·»åŠ è¿æ¥å¼¹çª— -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ·»åŠ æ•°æ®åº“è¿æ¥</div>
            <div class="form-group">
                <label>è¿æ¥åç§°</label>
                <input type="text" id="dbName" placeholder="ä¾‹å¦‚: ç”Ÿäº§ MySQL">
            </div>
            <div class="form-group">
                <label>ç±»å‹</label>
                <select id="dbType">
                    <option value="mysql">MySQL / MariaDB</option>
                    <option value="redis">Redis</option>
                    <option value="postgresql">PostgreSQL</option>
                </select>
            </div>
            <div class="form-group">
                <label>ä¸»æœº</label>
                <input type="text" id="dbHost" value="localhost" placeholder="localhost">
            </div>
            <div class="form-group">
                <label>ç«¯å£</label>
                <input type="number" id="dbPort" value="3306" placeholder="3306">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="dbUser" placeholder="root">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="dbPass" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>æ•°æ®åº“åï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="dbDatabase" placeholder="ä¾‹å¦‚: myapp">
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button onclick="saveConnection()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
    let connections = [];
    let currentConn = null;
    
    function $(id) { return document.getElementById(id); }
    
    function showStatus(msg, error) {
        const el = $('statusBar');
        if (msg) {
            el.textContent = msg;
            el.style.background = error ? '#c72e0f' : '#007acc';
            el.style.display = 'flex';
        } else {
            el.style.display = 'none';
        }
    }
    
    async function loadConnections() {
        try {
            const r = await fetch('/api/db/connections');
            const data = await r.json();
            if (data.success) {
                connections = (data.data && data.data.connections) || [];
                renderConnections();
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    function renderConnections() {
        const select = $('connSelect');
        const sidebar = $('sidebar');
        
        let options = '<option value="">é€‰æ‹©æ•°æ®åº“è¿æ¥...</option>';
        let sidebarHtml = '';
        
        connections.forEach(c => {
            const icon = c.type === 'mysql' ? 'ğŸ—„ï¸' : c.type === 'redis' ? 'ğŸ“¦' : 'ğŸ˜';
            options += `<option value="${c.id}">${icon} ${c.name || c.host}</option>`;
            sidebarHtml += `
                <div class="conn-item" onclick="selectConn('${c.id}')" id="conn-${c.id}">
                    <span class="conn-icon">${icon}</span>
                    <span class="conn-name">${c.name || c.host}</span>
                </div>
            `;
        });
        
        select.innerHTML = options;
        sidebar.innerHTML = sidebarHtml || '<div class="empty">è¯·æ·»åŠ æ•°æ®åº“è¿æ¥</div>';
    }
    
    function selectConn(id) {
        currentConn = connections.find(c => c.id === id);
        document.querySelectorAll('.conn-item').forEach(el => el.classList.remove('active'));
        $('conn-' + id)?.classList.add('active');
        $('connSelect').value = id;
        
        // åŠ è½½æ•°æ®åº“ä¿¡æ¯
        if (currentConn.type === 'redis') {
            loadRedisInfo();
        } else {
            loadMySQLInfo();
        }
    }
    
    function connectDB() {
        const id = $('connSelect').value;
        if (id) selectConn(id);
    }
    
    async function loadRedisInfo() {
        const params = new URLSearchParams({
            host: currentConn.host,
            port: currentConn.port,
            password: currentConn.password || ''
        });
        try {
            const r = await fetch('/api/db/redis/info?' + params);
            const data = await r.json();
            if (data.success) {
                const info = data.info || {};
                $('results').innerHTML = `
                    <h3 style="margin-bottom:12px;">Redis ä¿¡æ¯</h3>
                    <table class="table">
                        <tr><td>ç‰ˆæœ¬</td><td>${info.redis_version || '-'}</td></tr>
                        <tr><td>å†…å­˜</td><td>${info.used_memory_human || '-'}</td></tr>
                        <tr><td>å®¢æˆ·ç«¯</td><td>${info.connected_clients || '-'}</td></tr>
                        <tr><td>é”®æ•°é‡</td><td>${info.dbkeys || '-'}</td></tr>
                    </table>
                `;
            } else {
                showStatus(data.error || 'è¿æ¥å¤±è´¥', true);
            }
        } catch (e) {
            showStatus(e.message, true);
        }
    }
    
    async function loadMySQLInfo() {
        showStatus('åŠ è½½ä¸­...');
        const params = new URLSearchParams({
            host: currentConn.host,
            port: currentConn.port,
            user: currentConn.user,
            password: currentConn.password || '',
            database: currentConn.database || ''
        });
        try {
            const r = await fetch('/api/db/mysql/status?' + params);
            const data = await r.json();
            if (data.success) {
                $('results').innerHTML = `
                    <h3 style="margin-bottom:12px;">æ•°æ®åº“: ${currentConn.database || 'æ‰€æœ‰æ•°æ®åº“'}</h3>
                    <pre style="white-space:pre-wrap;word-break:break-all;">${data.output || ''}</pre>
                `;
                showStatus('');
            } else {
                showStatus(data.error || 'è¿æ¥å¤±è´¥', true);
            }
        } catch (e) {
            showStatus(e.message, true);
        }
    }
    
    async function executeQuery() {
        if (!currentConn) {
            alert('è¯·å…ˆé€‰æ‹©æ•°æ®åº“è¿æ¥');
            return;
        }
        
        const query = $('query').value.trim();
        if (!query) return;
        
        showStatus('æ‰§è¡Œä¸­...');
        try {
            const r = await fetch('/api/db/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection: currentConn.id,
                    query: query
                })
            });
            const data = await r.json();
            
            if (data.success) {
                const rows = (data.data && data.data.rows) || [];
                const headers = (data.data && data.data.headers) || [];
                showStatus(`æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${rows.length || 0} è¡Œ`);
                
                if (rows.length > 0) {
                    $('results').innerHTML = `
                        <table class="table">
                            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>
                                ${rows.map(row => `<tr>${row.map(cell => `<td>${cell || ''}</td>`).join('')}</tr>`).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    $('results').innerHTML = '<div class="empty">æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸï¼Œæ— è¿”å›æ•°æ®</div>';
                }
            } else {
                showStatus(data.error || 'æŸ¥è¯¢å¤±è´¥', true);
            }
        } catch (e) {
            showStatus(e.message, true);
        }
    }
    
    function openAddModal() {
        $('addModal').classList.add('open');
        $('dbName').value = '';
        $('dbHost').value = 'localhost';
        $('dbPort').value = '3306';
        $('dbUser').value = '';
        $('dbPass').value = '';
        $('dbDatabase').value = '';
    }
    
    function closeAddModal() {
        $('addModal').classList.remove('open');
    }
    
    async function saveConnection() {
        const conn = {
            name: $('dbName').value || $('dbHost').value,
            type: $('dbType').value,
            host: $('dbHost').value,
            port: $('dbPort').value,
            user: $('dbUser').value,
            password: $('dbPass').value,
            database: $('dbDatabase').value
        };
        
        try {
            const r = await fetch('/api/db/connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(conn)
            });
            const data = await r.json();
            if (data.success) {
                closeAddModal();
                loadConnections();
                showStatus('è¿æ¥å·²ä¿å­˜');
            } else {
                alert(data.error || 'ä¿å­˜å¤±è´¥');
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    async function testConnection() {
        const type = $('dbType').value;
        const conn = {
            type: type,
            host: $('dbHost').value,
            port: $('dbPort').value,
            user: $('dbUser').value,
            password: $('dbPass').value
        };
        
        try {
            const r = await fetch('/api/db/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(conn)
            });
            const data = await r.json();
            alert(data.success ? 'è¿æ¥æˆåŠŸï¼' : (data.message || 'è¿æ¥å¤±è´¥'));
        } catch (e) {
            alert(e.message);
        }
    }
    
    function refreshDB() {
        if (currentConn) {
            selectConn(currentConn.id);
        }
    }
    
    // Ctrl+Enter æ‰§è¡ŒæŸ¥è¯¢
    $('query').addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            executeQuery();
        }
    });
    
    loadConnections();
    </script>
</body>
</html>
