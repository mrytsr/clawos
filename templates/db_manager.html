<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #1a1a2e; color: #e0e0e0; 
        }
        
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* é¡¶éƒ¨æ  */
        .header {
            flex-shrink: 0;
            display: flex; align-items: center; gap: 16px; padding: 12px 16px;
            background: #16213e; border-bottom: 1px solid #0f3460;
        }
        .header h1 { font-size: 16px; font-weight: 500; color: #fff; margin-right: auto; }
        
        .header select, .header button, .header input {
            padding: 6px 12px; border-radius: 6px; border: 1px solid #0f3460;
            background: #1a1a2e; color: #e0e0e0; font-size: 13px;
        }
        .header button {
            cursor: pointer; background: #e94560; color: #fff; border: none;
            transition: all 0.2s;
        }
        .header button:hover { background: #ff6b6b; }
        .header button.secondary { background: #0f3460; }
        .header button.secondary:hover { background: #1a4a7a; }
        
        /* ä¸»å¸ƒå±€ */
        .main { flex: 1; display: flex; overflow: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 220px; flex-shrink: 0;
            background: #16213e; border-right: 1px solid #0f3460;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 12px; border-bottom: 1px solid #0f3460;
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-header span { font-size: 12px; color: #888; text-transform: uppercase; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 8px; }
        
        /* è¿æ¥å¡ç‰‡ */
        .conn-card {
            background: #1a1a2e; border-radius: 8px; padding: 12px; margin-bottom: 8px;
            cursor: pointer; border: 1px solid transparent;
            transition: all 0.2s;
        }
        .conn-card:hover { border-color: #0f3460; }
        .conn-card.active { border-color: #e94560; background: #1f1f3a; }
        .conn-card .name { font-size: 14px; font-weight: 500; color: #fff; margin-bottom: 4px; }
        .conn-card .info { font-size: 11px; color: #888; }
        .conn-card .actions { display: flex; gap: 8px; margin-top: 8px; opacity: 0; transition: opacity 0.2s; }
        .conn-card:hover .actions { opacity: 1; }
        .conn-card .actions button {
            padding: 4px 8px; font-size: 11px; border-radius: 4px;
            background: #0f3460; border: none; color: #ccc; cursor: pointer;
        }
        .conn-card .actions button:hover { background: #e94560; color: #fff; }
        
        /* æ•°æ®åº“åˆ—è¡¨ */
        .db-list { margin-top: 16px; }
        .db-item {
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 13px;
            margin-bottom: 2px;
        }
        .db-item:hover { background: #1a1a2e; }
        .db-item.active { background: #0f3460; color: #e94560; }
        
        /* è¡¨åˆ—è¡¨ */
        .table-list { margin-left: 16px; }
        .table-item {
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 12px;
            color: #aaa; margin-bottom: 2px;
        }
        .table-item:hover { background: #1a1a2e; color: #fff; }
        .table-item.active { background: #0f3460; color: #e94560; }
        .table-item .rows { margin-left: auto; font-size: 10px; color: #666; }
        
        /* å†…å®¹åŒº */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* SQL ç¼–è¾‘å™¨ */
        .sql-editor {
            flex-shrink: 0;
            background: #16213e; border-bottom: 1px solid #0f3460;
            padding: 12px;
        }
        .sql-editor textarea {
            width: 100%; height: 100px;
            background: #1a1a2e; border: 1px solid #0f3460; border-radius: 6px;
            color: #e0e0e0; font-family: 'SF Mono', 'Consolas', monospace; font-size: 13px;
            padding: 10px; resize: vertical; outline: none;
        }
        .sql-editor textarea:focus { border-color: #e94560; }
        
        .sql-toolbar { display: flex; gap: 8px; margin-top: 8px; align-items: center; }
        .sql-toolbar button { padding: 6px 14px; border-radius: 6px; font-size: 12px; }
        .quick-btns { display: flex; gap: 6px; margin-left: auto; }
        .quick-btns button { background: #0f3460; border: none; padding: 5px 10px; font-size: 11px; }
        
        /* ç»“æœåŒº */
        .results { flex: 1; overflow: auto; padding: 12px; background: #1a1a2e; }
        .results-empty { 
            text-align: center; color: #666; padding: 40px; 
            font-size: 14px;
        }
        
        /* æ•°æ®è¡¨ */
        .data-table-wrapper { overflow: auto; max-height: 100%; }
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
        }
        .data-table th, .data-table td {
            padding: 8px 12px; text-align: left; border-bottom: 1px solid #0f3460;
            white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis;
        }
        .data-table th {
            background: #16213e; color: #e94560; font-weight: 500;
            position: sticky; top: 0; z-index: 10;
        }
        .data-table tr:hover { background: #1f1f3a; }
        .data-table td { color: #ccc; font-family: 'SF Mono', monospace; font-size: 11px; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            flex-shrink: 0;
            display: flex; align-items: center; gap: 16px; padding: 8px 12px;
            background: #16213e; border-top: 1px solid #0f3460;
            font-size: 11px; color: #888;
        }
        .status-bar .success { color: #4ade80; }
        .status-bar .error { color: #ef4444; }
        
        /* å¼¹çª— */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #16213e; border-radius: 12px; padding: 24px;
            width: 400px; max-width: 90vw;
        }
        .modal-title { font-size: 16px; font-weight: 500; margin-bottom: 20px; color: #fff; }
        .modal-content .form-group { margin-bottom: 16px; }
        .modal-content label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .modal-content input, .modal-content select {
            width: 100%; padding: 10px; border-radius: 6px;
            background: #1a1a2e; border: 1px solid #0f3460; color: #fff;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 24px; }
        .modal-actions button { flex: 1; padding: 10px; border-radius: 6px; border: none; cursor: pointer; }
        .modal-actions .cancel { background: #0f3460; color: #ccc; }
        .modal-actions .confirm { background: #e94560; color: #fff; }
        
        /* åŠ è½½ */
        .loading { 
            display: flex; align-items: center; justify-content: center; padding: 40px; 
            color: #666;
        }
        .spinner {
            width: 20px; height: 20px; border: 2px solid #0f3460;
            border-top-color: #e94560; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Tab åˆ‡æ¢ */
        .tab-bar {
            display: flex; gap: 4px; background: #1a1a2e; padding: 4px; border-radius: 6px;
        }
        .tab-btn {
            padding: 6px 12px; border-radius: 4px; border: none;
            background: transparent; color: #888; cursor: pointer; font-size: 12px;
        }
        .tab-btn.active { background: #0f3460; color: #e94560; }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨æ  -->
        <div class="header">
            <h1>ğŸ“Š æ•°æ®åº“ç®¡ç†</h1>
            <select id="connSelect" onchange="selectConnection()">
                <option value="">é€‰æ‹©è¿æ¥...</option>
            </select>
            <button onclick="openAddModal()">+ æ–°å»º</button>
            <button class="secondary" onclick="openDbModal()">ğŸ“¦ æ–°å»ºæ•°æ®åº“</button>
        </div>
        
        <!-- ä¸»å†…å®¹ -->
        <div class="main">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="sidebar-content" id="sidebarContent">
                    <div class="results-empty">è¯·å…ˆé€‰æ‹©æ•°æ®åº“è¿æ¥</div>
                </div>
            </div>
            
            <!-- å†…å®¹åŒº -->
            <div class="content">
                <!-- SQL ç¼–è¾‘å™¨ -->
                <div class="sql-editor">
                    <textarea id="sqlEditor" placeholder="è¾“å…¥ SQL æŸ¥è¯¢... (Ctrl+Enter æ‰§è¡Œ)"></textarea>
                    <div class="sql-toolbar">
                        <button onclick="executeQuery()">â–¶ æ‰§è¡Œ</button>
                        <button class="secondary" onclick="clearEditor()">æ¸…ç©º</button>
                        <div class="quick-btns">
                            <button onclick="quickQuery('SHOW TABLES')">Tables</button>
                            <button onclick="quickQuery('SHOW PROCESSLIST')">Process</button>
                            <button onclick="quickQuery('SHOW STATUS')">Status</button>
                        </div>
                    </div>
                </div>
                
                <!-- ç»“æœ -->
                <div class="results" id="results">
                    <div class="results-empty">æ‰§è¡Œ SQL æŸ¥è¯¢æŸ¥çœ‹ç»“æœ</div>
                </div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <span>å°±ç»ª</span>
        </div>
    </div>
    
    <!-- æ·»åŠ è¿æ¥å¼¹çª— -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ–°å»º MySQL è¿æ¥</div>
            <div class="form-group">
                <label>è¿æ¥åç§°</label>
                <input type="text" id="dbName" placeholder="ä¾‹å¦‚: ç”Ÿäº§åº“">
            </div>
            <div class="form-group">
                <label>ä¸»æœº</label>
                <input type="text" id="dbHost" placeholder="localhost">
            </div>
            <div class="form-group">
                <label>ç«¯å£</label>
                <input type="number" id="dbPort" value="3306">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="dbUser" placeholder="root">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="dbPass" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>é»˜è®¤æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="dbDatabase" placeholder="ä¸å¡«åˆ™ç¨åé€‰æ‹©">
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="testAndSave()">æµ‹è¯•å¹¶ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å»ºæ•°æ®åº“å¼¹çª— -->
    <div id="dbModal" class="modal">
        <div class="modal-content" style="width: 320px;">
            <div class="modal-title">æ–°å»ºæ•°æ®åº“</div>
            <div class="form-group">
                <label>æ•°æ®åº“å</label>
                <input type="text" id="newDbName" placeholder="ä¾‹å¦‚: myapp_db">
            </div>
            <div class="form-group">
                <label>å­—ç¬¦é›†</label>
                <select id="dbCharset">
                    <option value="utf8mb4">utf8mb4</option>
                    <option value="utf8">utf8</option>
                    <option value="latin1">latin1</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeDbModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="createDatabase()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        let connections = [];
        let currentConn = null;
        let currentDb = null;
        let currentTable = null;
        
        // å·¥å…·å‡½æ•°
        const $ = id => document.getElementById(id);
        
        function showStatus(msg, error) {
            const bar = $('statusBar');
            bar.innerHTML = `<span class="${error ? 'error' : 'success'}">${msg}</span>`;
        }
        
        function formatBytes(bytes) {
            if (!bytes || bytes === '0') return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(parseInt(bytes)) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
        }
        
        // åŠ è½½è¿æ¥åˆ—è¡¨
        async function loadConnections() {
            try {
                const r = await fetch('/api/db/connections');
                const data = await r.json();
                if (data.success) {
                    connections = data.data?.connections || [];
                    renderConnectionSelect();
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        function renderConnectionSelect() {
            let html = '<option value="">é€‰æ‹©è¿æ¥...</option>';
            connections.forEach(c => {
                html += `<option value="${c.id}">${c.name} (${c.host})</option>`;
            });
            $('connSelect').innerHTML = html;
        }
        
        // é€‰æ‹©è¿æ¥
        async function selectConnection() {
            const id = $('connSelect').value;
            if (!id) {
                currentConn = null;
                $('sidebarContent').innerHTML = '<div class="results-empty">è¯·å…ˆé€‰æ‹©è¿æ¥</div>';
                return;
            }
            
            currentConn = connections.find(c => c.id === id);
            await loadDatabases();
        }
        
        // åŠ è½½æ•°æ®åº“åˆ—è¡¨
        async function loadDatabases() {
            if (!currentConn) return;
            
            $('sidebarContent').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            
            try {
                const r = await fetch(`/api/db/${currentConn.id}/databases`);
                const data = await r.json();
                
                if (data.success) {
                    const dbs = data.data?.databases || [];
                    renderDatabases(dbs);
                }
            } catch (e) {
                showStatus('åŠ è½½å¤±è´¥: ' + e.message, true);
            }
        }
        
        function renderDatabases(dbs) {
            let html = '';
            
            // è¿æ¥ä¿¡æ¯
            html += `
                <div class="conn-card active">
                    <div class="name">${currentConn.name}</div>
                    <div class="info">${currentConn.host}:${currentConn.port}</div>
                    <div class="actions">
                        <button onclick="deleteConnection('${currentConn.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `;
            
            // æ•°æ®åº“åˆ—è¡¨
            html += '<div class="db-list">';
            dbs.forEach(db => {
                html += `
                    <div class="db-item" onclick="selectDatabase('${db}')" id="db-${db}">
                        <span>ğŸ“</span>
                        <span>${db}</span>
                    </div>
                `;
            });
            html += '</div>';
            
            $('sidebarContent').innerHTML = html;
        }
        
        // é€‰æ‹©æ•°æ®åº“
        async function selectDatabase(dbName) {
            currentDb = dbName;
            
            // é«˜äº®
            document.querySelectorAll('.db-item').forEach(el => el.classList.remove('active'));
            $('db-' + dbName)?.classList.add('active');
            
            await loadTables(dbName);
        }
        
        // åŠ è½½è¡¨åˆ—è¡¨
        async function loadTables(dbName) {
            if (!currentConn) return;
            
            try {
                const r = await fetch(`/api/db/${currentConn.id}/tables`);
                const data = await r.json();
                
                if (data.success) {
                    const tables = data.data?.tables || [];
                    renderTables(tables);
                }
            } catch (e) {
                showStatus('åŠ è½½å¤±è´¥: ' + e.message, true);
            }
        }
        
        function renderTables(tables) {
            let html = '<div class="table-list">';
            
            if (tables.length === 0) {
                html += '<div style="padding:8px;color:#666;font-size:12px;">æ— è¡¨</div>';
            } else {
                tables.forEach(t => {
                    html += `
                        <div class="table-item" onclick="showTableData('${t.name}')" id="table-${t.name}">
                            <span>ğŸ“‹</span>
                            <span>${t.name}</span>
                            <span class="rows">${parseInt(t.rows || 0).toLocaleString()}</span>
                        </div>
                    `;
                });
            }
            html += '</div>';
            
            // è¿½åŠ åˆ°ä¾§è¾¹æ 
            const existingList = $('sidebarContent').querySelector('.table-list');
            if (existingList) existingList.remove();
            $('sidebarContent').innerHTML += html;
        }
        
        // æ˜¾ç¤ºè¡¨æ•°æ®
        async function showTableData(tableName) {
            currentTable = tableName;
            
            // é«˜äº®
            document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
            $('table-' + tableName)?.classList.add('active');
            
            // åŠ è½½æ•°æ®
            const sql = `SELECT * FROM \`${tableName}\` LIMIT 100`;
            $('sqlEditor').value = sql;
            await executeQuery();
        }
        
        // æ‰§è¡Œ SQL
        async function executeQuery() {
            if (!currentConn) {
                showStatus('è¯·å…ˆé€‰æ‹©æ•°æ®åº“è¿æ¥', true);
                return;
            }
            
            const sql = $('sqlEditor').value.trim();
            if (!sql) return;
            
            $('results').innerHTML = '<div class="loading"><div class="spinner"></div>æ‰§è¡Œä¸­...</div>';
            
            try {
                const r = await fetch('/api/db/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        connection: currentConn.id,
                        query: sql
                    })
                });
                const data = await r.json();
                
                if (data.success) {
                    renderResults(data.data);
                    showStatus(`æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${data.data?.rows?.length || 0} è¡Œ`, false);
                } else {
                    showStatus('æ‰§è¡Œå¤±è´¥: ' + data.message, true);
                    $('results').innerHTML = `<div class="results-empty" style="color:#ef4444;">${data.message}</div>`;
                }
            } catch (e) {
                showStatus('æ‰§è¡Œå¤±è´¥: ' + e.message, true);
                $('results').innerHTML = `<div class="results-empty" style="color:#ef4444;">${e.message}</div>`;
            }
        }
        
        function renderResults(data) {
            const headers = data.headers || [];
            const rows = data.rows || [];
            
            if (rows.length === 0) {
                $('results').innerHTML = '<div class="results-empty">æ— æ•°æ®</div>';
                return;
            }
            
            let html = '<div class="data-table-wrapper"><table class="data-table"><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell || ''}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            $('results').innerHTML = html;
        }
        
        function quickQuery(sql) {
            if (!currentConn) {
                showStatus('è¯·å…ˆé€‰æ‹©æ•°æ®åº“è¿æ¥', true);
                return;
            }
            $('sqlEditor').value = sql;
            executeQuery();
        }
        
        function clearEditor() {
            $('sqlEditor').value = '';
        }
        
        // å¼¹çª—æ§åˆ¶
        function openAddModal() { $('addModal').classList.add('show'); }
        function closeAddModal() { $('addModal').classList.remove('show'); }
        function openDbModal() { 
            if (!currentConn) {
                showStatus('è¯·å…ˆé€‰æ‹©æ•°æ®åº“è¿æ¥', true);
                return;
            }
            $('dbModal').classList.add('show'); 
        }
        function closeDbModal() { $('dbModal').classList.remove('show'); }
        
        // æµ‹è¯•å¹¶ä¿å­˜è¿æ¥
        async function testAndSave() {
            const data = {
                name: $('dbName').value,
                host: $('dbHost').value,
                port: $('dbPort').value || '3306',
                user: $('dbUser').value,
                password: $('dbPass').value,
                database: $('dbDatabase').value
            };
            
            if (!data.name || !data.host || !data.user) {
                alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯');
                return;
            }
            
            try {
                const r = await fetch('/api/db/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await r.json();
                
                if (result.success) {
                    await fetch('/api/db/connect', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    closeAddModal();
                    loadConnections();
                    showStatus('è¿æ¥å·²ä¿å­˜', false);
                } else {
                    alert('è¿æ¥å¤±è´¥: ' + result.message);
                }
            } catch (e) {
                alert('è¿æ¥å¤±è´¥: ' + e.message);
            }
        }
        
        // åˆ é™¤è¿æ¥
        async function deleteConnection(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è¿æ¥ï¼Ÿ')) return;
            
            try {
                const r = await fetch(`/api/db/connection/${id}`, {method: 'DELETE'});
                const data = await r.json();
                if (data.success) {
                    currentConn = null;
                    loadConnections();
                    $('sidebarContent').innerHTML = '<div class="results-empty">è¯·å…ˆé€‰æ‹©è¿æ¥</div>';
                    showStatus('è¿æ¥å·²åˆ é™¤', false);
                }
            } catch (e) {
                showStatus('åˆ é™¤å¤±è´¥: ' + e.message, true);
            }
        }
        
        // åˆ›å»ºæ•°æ®åº“
        async function createDatabase() {
            const dbName = $('newDbName').value.trim();
            if (!dbName) {
                alert('è¯·è¾“å…¥æ•°æ®åº“å');
                return;
            }
            
            try {
                const r = await fetch('/api/db/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        connection: currentConn.id,
                        query: `CREATE DATABASE \`${dbName}\``
                    })
                });
                const data = await r.json();
                
                if (data.success) {
                    closeDbModal();
                    loadDatabases();
                    showStatus('æ•°æ®åº“åˆ›å»ºæˆåŠŸ', false);
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + data.message);
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                executeQuery();
            }
        });
        
        // åˆå§‹åŒ–
        loadConnections();
    </script>
</body>
</html>
