<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL ç®¡ç†</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1e1e1e; color: #ccc; }
        
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            flex-shrink: 0;
            display: flex; align-items: center; gap: 12px; padding: 8px 12px;
            background: #252526; border-bottom: 1px solid #404040;
        }
        .toolbar select, .toolbar button, .toolbar input {
            padding: 6px 10px; border-radius: 4px; border: 1px solid #404040;
            background: #3c3c3c; color: #ccc; font-size: 13px;
        }
        .toolbar button {
            cursor: pointer; background: #0e639c; color: #fff; border: none;
        }
        .toolbar button:hover { background: #1177bb; }
        .toolbar button.secondary { background: #3c3c3c; }
        .toolbar button.danger { background: #cf222e; }
        
        /* ä¸»å¸ƒå±€ */
        .main { flex: 1; display: flex; overflow: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 240px; flex-shrink: 0;
            background: #252526; border-right: 1px solid #404040;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 10px 12px; border-bottom: 1px solid #404040;
            display: flex; align-items: center; gap: 8px;
        }
        .sidebar-header span { font-size: 12px; color: #888; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 8px; }
        
        /* è¿æ¥é¡¹ */
        .conn-group { margin-bottom: 16px; }
        .conn-group-title {
            font-size: 11px; color: #666; padding: 4px 8px; text-transform: uppercase;
        }
        .conn-item {
            padding: 8px 10px; border-radius: 6px; cursor: pointer; margin-bottom: 2px;
            display: flex; align-items: center; gap: 8px;
            font-size: 13px;
        }
        .conn-item:hover { background: #3c3c3c; }
        .conn-item.active { background: #0e639c; color: #fff; }
        .conn-item .icon { font-size: 14px; }
        .conn-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* æ•°æ®åº“é¡¹ */
        .db-item {
            padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left: 20px;
            font-size: 12px; display: flex; align-items: center; gap: 6px;
        }
        .db-item:hover { background: #3c3c3c; }
        .db-item.active { color: #58a6ff; }
        
        /* è¡¨é¡¹ */
        .table-item {
            padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left: 20px;
            font-size: 12px; display: flex; align-items: center; gap: 6px;
            color: #ccc;
        }
        .table-item:hover { background: #3c3c3c; }
        .table-item .table-icon { color: #8250df; }
        .table-item .row-count { color: #666; font-size: 11px; margin-left: auto; }
        
        /* å†…å®¹åŒº */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* SQL ç¼–è¾‘å™¨ */
        .sql-editor {
            flex-shrink: 0;
            background: #252526; border-bottom: 1px solid #404040;
            padding: 8px 12px;
        }
        .sql-editor textarea {
            width: 100%; height: 80px;
            background: #1e1e1e; border: 1px solid #404040; border-radius: 4px;
            color: #ccc; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px;
            padding: 8px; resize: vertical; outline: none;
        }
        .sql-editor textarea:focus { border-color: #0e639c; }
        
        .sql-toolbar {
            display: flex; gap: 8px; margin-top: 8px; align-items: center;
        }
        .sql-toolbar button { padding: 5px 12px; font-size: 12px; }
        .sql-toolbar .history-btn { margin-left: auto; }
        
        /* ç»“æœåŒº */
        .results {
            flex: 1; overflow: auto; padding: 12px;
        }
        .results-empty {
            text-align: center; padding: 40px; color: #666;
        }
        
        /* è¡¨æ ¼ */
        .table-wrapper { overflow: auto; max-height: 100%; }
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
        }
        .data-table th, .data-table td {
            padding: 6px 10px; border: 1px solid #404040; text-align: left;
            white-space: nowrap; max-width: 300px; overflow: hidden; text-overflow: ellipsis;
        }
        .data-table th {
            background: #252526; position: sticky; top: 0; z-index: 1;
            font-weight: 500;
        }
        .data-table tr:nth-child(even) { background: #252526; }
        .data-table tr:hover { background: #2d2d2d; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            flex-shrink: 0;
            padding: 6px 12px; background: #007acc; color: #fff; font-size: 12px;
            display: flex; justify-content: space-between;
        }
        
        /* è¡¨ç»“æ„é¢æ¿ */
        .schema-panel {
            width: 300px; flex-shrink: 0;
            background: #252526; border-left: 1px solid #404040;
            display: none; flex-direction: column; overflow: hidden;
        }
        .schema-panel.open { display: flex; }
        .schema-header {
            padding: 10px 12px; border-bottom: 1px solid #404040;
            font-size: 13px; font-weight: 500;
        }
        .schema-content { flex: 1; overflow-y: auto; padding: 12px; }
        .schema-section { margin-bottom: 16px; }
        .schema-section-title {
            font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 8px;
        }
        .schema-item {
            padding: 4px 8px; background: #2d2d2d; border-radius: 4px;
            font-size: 12px; margin-bottom: 4px;
        }
        .schema-item .type { color: #8250df; font-size: 11px; }
        
        /* å¼¹çª— */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #2d2d2d; border-radius: 12px; padding: 20px; width: 420px; max-width: 90%;
        }
        .modal-title { font-size: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #404040;
            background: #3c3c3c; color: #ccc; font-size: 13px;
        }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        
        /* SQL é«˜äº®å…³é”®è¯ */
        .sql-keyword { color: #8250df; font-weight: 500; }
        .sql-string { color: #a0d911; }
        .sql-number { color: #79c0ff; }
        .sql-comment { color: #8b949e; }
        
        /* å†å²è®°å½•é¢æ¿ */
        .history-panel {
            position: absolute; top: 100%; right: 12px;
            background: #2d2d2d; border: 1px solid #404040; border-radius: 8px;
            width: 300px; max-height: 300px; overflow-y: auto;
            display: none; z-index: 100;
        }
        .history-panel.open { display: block; }
        .history-item {
            padding: 8px 12px; cursor: pointer; font-size: 12px;
            border-bottom: 1px solid #404040;
        }
        .history-item:hover { background: #3c3c3c; }
        .history-item .time { color: #666; font-size: 11px; }
        .history-item .sql { 
            font-family: monospace; font-size: 11px; color: #ccc;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px;
        }
        
        /* å¿«æ·æ“ä½œ */
        .quick-actions {
            display: flex; gap: 4px; margin-left: 8px;
        }
        .quick-btn {
            padding: 4px 8px; font-size: 11px; border-radius: 4px;
            background: #3c3c3c; color: #ccc; border: none; cursor: pointer;
        }
        .quick-btn:hover { background: #404040; }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="toolbar">
            <select id="connSelect" onchange="selectConnection()">
                <option value="">é€‰æ‹©è¿æ¥...</option>
            </select>
            <button onclick="openAddModal()">+ æ–°å»º</button>
            <button class="secondary" onclick="openHistoryPanel()">ğŸ“‹ å†å²</button>
            <div id="historyPanel" class="history-panel"></div>
        </div>
        
        <!-- ä¸»å†…å®¹ -->
        <div class="main">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <span>æ•°æ®åº“</span>
                    <button class="quick-btn" onclick="openDbModal()" title="æ–°å»ºæ•°æ®åº“">+</button>
                </div>
                <div class="sidebar-content" id="sidebarContent">
                    <div class="results-empty">è¯·å…ˆé€‰æ‹©è¿æ¥</div>
                </div>
            </div>
            
            <!-- å†…å®¹åŒº -->
            <div class="content">
                <!-- SQL ç¼–è¾‘å™¨ -->
                <div class="sql-editor">
                    <textarea id="sqlEditor" placeholder="è¾“å…¥ SQL æŸ¥è¯¢... (Ctrl+Enter æ‰§è¡Œ)"></textarea>
                    <div class="sql-toolbar">
                        <button onclick="executeQuery()">â–¶ æ‰§è¡Œ</button>
                        <button class="secondary" onclick="clearEditor()">æ¸…ç©º</button>
                        <button class="secondary" onclick="saveAsTemplate()">ğŸ’¾ å­˜ä¸ºæ¨¡æ¿</button>
                        <div class="quick-actions">
                            <button class="quick-btn" onclick="quickQuery('SHOW TABLES')">Tables</button>
                            <button class="quick-btn" onclick="quickQuery('SHOW PROCESSLIST')">Process</button>
                            <button class="quick-btn" onclick="quickQuery('SHOW STATUS')">Status</button>
                        </div>
                    </div>
                </div>
                
                <!-- ç»“æœ -->
                <div class="results" id="results">
                    <div class="results-empty">è¿æ¥æ•°æ®åº“åæ‰§è¡ŒæŸ¥è¯¢</div>
                </div>
                
                <!-- è¡¨ç»“æ„é¢æ¿ -->
                <div class="schema-panel" id="schemaPanel">
                    <div class="schema-header" id="schemaTitle">è¡¨ç»“æ„</div>
                    <div class="schema-content" id="schemaContent"></div>
                </div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <span id="statusText">å°±ç»ª</span>
            <span id="paginationInfo"></span>
        </div>
    </div>

    <!-- æ·»åŠ è¿æ¥å¼¹çª— -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ–°å»º MySQL è¿æ¥</div>
            <div class="form-group">
                <label>è¿æ¥åç§°</label>
                <input type="text" id="dbName" placeholder="ä¾‹å¦‚: ç”Ÿäº§åº“">
            </div>
            <div class="form-group">
                <label>ä¸»æœº</label>
                <input type="text" id="dbHost" placeholder="localhost">
            </div>
            <div class="form-group">
                <label>ç«¯å£</label>
                <input type="number" id="dbPort" value="3306">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="dbUser" placeholder="root">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="dbPass" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>é»˜è®¤æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="dbDatabase" placeholder="ä¸é€‰åˆ™ç¨åé€‰æ‹©">
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button onclick="testAndSave()">æµ‹è¯•å¹¶ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºæ•°æ®åº“å¼¹çª— -->
    <div id="dbModal" class="modal">
        <div class="modal-content" style="width: 320px;">
            <div class="modal-title">æ–°å»ºæ•°æ®åº“</div>
            <div class="form-group">
                <label>æ•°æ®åº“å</label>
                <input type="text" id="newDbName" placeholder="ä¾‹å¦‚: myapp_db">
            </div>
            <div class="form-group">
                <label>å­—ç¬¦é›†</label>
                <select id="dbCharset">
                    <option value="utf8mb4">utf8mb4</option>
                    <option value="utf8">utf8</option>
                    <option value="latin1">latin1</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="closeDbModal()">å–æ¶ˆ</button>
                <button onclick="createDatabase()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
    // å…¨å±€çŠ¶æ€
    let connections = [];
    let currentConn = null;
    let currentDb = null;
    let currentTable = null;
    let queryHistory = JSON.parse(localStorage.getItem('mysql_query_history') || '[]').slice(0, 50);
    
    // å·¥å…·å‡½æ•°
    const $ = id => document.getElementById(id);
    
    function showStatus(msg, error) {
        const el = $('statusBar');
        el.style.background = error ? '#cf222e' : '#007acc';
        el.style.display = 'flex';
        $('statusText').textContent = msg;
    }
    
    function formatBytes(bytes) {
        if (!bytes || bytes === '0') return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(parseInt(bytes)) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // åŠ è½½è¿æ¥åˆ—è¡¨
    async function loadConnections() {
        try {
            const r = await fetch('/api/db/connections');
            const data = await r.json();
            if (data.success) {
                connections = data.data?.connections || [];
                renderConnectionSelect();
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    function renderConnectionSelect() {
        const select = $('connSelect');
        let html = '<option value="">é€‰æ‹©è¿æ¥...</option>';
        connections.forEach(c => {
            html += `<option value="${c.id}">${c.name || c.host}</option>`;
        });
        select.innerHTML = html;
    }
    
    async function selectConnection() {
        const id = $('connSelect').value;
        if (!id) {
            currentConn = null;
            $('sidebarContent').innerHTML = '<div class="results-empty">è¯·å…ˆé€‰æ‹©è¿æ¥</div>';
            return;
        }
        
        currentConn = connections.find(c => c.id === id);
        await loadDatabases();
    }
    
    async function loadDatabases() {
        if (!currentConn) return;
        
        try {
            const r = await fetch(`/api/db/${currentConn.id}/databases`);
            const data = await r.json();
            
            if (data.success) {
                const dbs = data.data?.databases || [];
                let html = '<div class="conn-group">';
                dbs.forEach(db => {
                    html += `
                        <div class="db-item" onclick="selectDatabase('${db}')" id="db-${db}">
                            <span>ğŸ“</span>
                            <span>${db}</span>
                        </div>
                        <div class="table-list" id="tables-${db}" style="display:none;"></div>
                    `;
                });
                html += '</div>';
                $('sidebarContent').innerHTML = html;
            }
        } catch (e) {
            showStatus('åŠ è½½æ•°æ®åº“å¤±è´¥', true);
        }
    }
    
    async function selectDatabase(dbName) {
        currentDb = dbName;
        
        // åˆ‡æ¢æ˜¾ç¤º
        document.querySelectorAll('.db-item').forEach(el => el.classList.remove('active'));
        $('db-' + dbName)?.classList.add('active');
        document.querySelectorAll('.table-list').forEach(el => el.style.display = 'none');
        
        // åŠ è½½è¡¨
        try {
            const r = await fetch(`/api/db/${currentConn.id}/tables`);
            const data = await r.json();
            
            if (data.success) {
                const tables = data.data?.tables || [];
                let html = '';
                tables.forEach(t => {
                    html += `
                        <div class="table-item" onclick="showTableData('${t.name}')" id="table-${t.name}">
                            <span class="table-icon">ğŸ“‹</span>
                            <span class="table-name">${t.name}</span>
                            <span class="row-count">${parseInt(t.rows || 0).toLocaleString()}</span>
                        </div>
                    `;
                });
                $('tables-' + dbName).innerHTML = html;
                $('tables-' + dbName).style.display = 'block';
            }
        } catch (e) {
            showStatus('åŠ è½½è¡¨å¤±è´¥', true);
        }
    }
    
    async function showTableData(tableName) {
        currentTable = tableName;
        
        // é«˜äº®å½“å‰è¡¨
        document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
        $('table-' + tableName)?.classList.add('active');
        
        // åŠ è½½è¡¨æ•°æ®
        try {
            const r = await fetch(`/api/db/${currentConn.id}/table/${tableName}/data?page=1&page_size=100`);
            const data = await r.json();
            
            if (data.success) {
                renderTableData(data.data);
                await loadTableSchema(tableName);
            }
        } catch (e) {
            showStatus('åŠ è½½æ•°æ®å¤±è´¥', true);
        }
    }
    
    async function loadTableSchema(tableName) {
        try {
            const r = await fetch(`/api/db/${currentConn.id}/table/${tableName}/schema`);
            const data = await r.json();
            
            if (data.success) {
                const cols = data.data?.columns || [];
                const idxs = data.data?.indexes || [];
                
                $('schemaTitle').textContent = `${tableName} ç»“æ„`;
                $('schemaPanel').classList.add('open');
                
                let html = '<div class="schema-section">';
                html += '<div class="schema-section-title">åˆ—</div>';
                cols.forEach(c => {
                    html += `<div class="schema-item">
                        <span style="color:#58a6ff;">${c.field}</span>
                        <span class="type">${c.type}</span>
                        ${c.key ? '<span style="color:#e3b341;">KEY</span>' : ''}
                    </div>`;
                });
                html += '</div>';
                
                if (idxs.length) {
                    html += '<div class="schema-section">';
                    html += '<div class="schema-section-title">ç´¢å¼•</div>';
                    idxs.forEach(i => {
                        html += `<div class="schema-item">
                            ${i.name} (${i.columns}) ${i.unique ? 'UNIQUE' : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                $('schemaContent').innerHTML = html;
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    function renderTableData(data) {
        const headers = data.headers || [];
        const rows = data.rows || [];
        const pagination = data.pagination || {};
        
        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        $('paginationInfo').textContent = `å…± ${pagination.total || 0} æ¡`;
        
        if (rows.length === 0) {
            $('results').innerHTML = '<div class="results-empty">æ— æ•°æ®</div>';
            return;
        }
        
        let html = '<div class="table-wrapper"><table class="data-table"><thead><tr>';
        headers.forEach(h => {
            html += `<th>${h}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        rows.forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
                html += `<td title="${cell || ''}">${cell || ''}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        
        $('results').innerHTML = html;
    }
    
    async function executeQuery() {
        if (!currentConn) {
            alert('è¯·å…ˆé€‰æ‹©æ•°æ®åº“è¿æ¥');
            return;
        }
        
        const query = $('sqlEditor').value.trim();
        if (!query) return;
        
        // ä¿å­˜åˆ°å†å²
        addToHistory(query);
        
        showStatus('æ‰§è¡Œä¸­...');
        
        try {
            const r = await fetch('/api/db/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection: currentConn.id,
                    query: query
                })
            });
            const data = await r.json();
            
            if (data.success) {
                if (data.data?.rows && data.data.rows.length > 0) {
                    renderTableData(data.data);
                    showStatus(`æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${data.data.rows.length} è¡Œ`);
                } else if (data.data?.affected !== undefined) {
                    showStatus(`æ‰§è¡ŒæˆåŠŸï¼Œå½±å“ ${data.data.affected} è¡Œ`);
                    // åˆ·æ–°å½“å‰è¡¨æ•°æ®
                    if (currentTable) {
                        showTableData(currentTable);
                    }
                } else {
                    $('results').innerHTML = '<div class="results-empty">æ‰§è¡ŒæˆåŠŸ</div>';
                    showStatus('æ‰§è¡ŒæˆåŠŸ');
                }
            } else {
                showStatus(data.error || 'æ‰§è¡Œå¤±è´¥', true);
            }
        } catch (e) {
            showStatus(e.message, true);
        }
    }
    
    function quickQuery(sql) {
        $('sqlEditor').value = sql;
        executeQuery();
    }
    
    function clearEditor() {
        $('sqlEditor').value = '';
    }
    
    function addToHistory(sql) {
        // é¿å…é‡å¤
        if (queryHistory[0] === sql) return;
        queryHistory.unshift(sql);
        queryHistory = queryHistory.slice(0, 50);
        localStorage.setItem('mysql_query_history', JSON.stringify(queryHistory));
    }
    
    function openHistoryPanel() {
        if (queryHistory.length === 0) {
            $('historyPanel').innerHTML = '<div style="padding:12px;color:#666;font-size:12px;">æš‚æ— å†å²</div>';
        } else {
            $('historyPanel').innerHTML = queryHistory.map((sql, i) => `
                <div class="history-item" onclick="useHistory(${i})">
                    <div class="time">${new Date().toLocaleTimeString()}</div>
                    <div class="sql">${sql.substring(0, 100)}</div>
                </div>
            `).join('');
        }
        $('historyPanel').classList.toggle('open');
    }
    
    function useHistory(index) {
        $('sqlEditor').value = queryHistory[index];
        $('historyPanel').classList.remove('open');
    }
    
    function saveAsTemplate() {
        const sql = $('sqlEditor').value.trim();
        if (!sql) return;
        const name = prompt('è¾“å…¥æ¨¡æ¿åç§°:');
        if (name) {
            const templates = JSON.parse(localStorage.getItem('sql_templates') || '{}');
            templates[name] = sql;
            localStorage.setItem('sql_templates', JSON.stringify(templates));
            alert('å·²ä¿å­˜');
        }
    }
    
    // è¿æ¥ç®¡ç†
    function openAddModal() {
        $('addModal').classList.add('open');
        $('dbName').value = '';
        $('dbHost').value = '';
        $('dbPort').value = '3306';
        $('dbUser').value = '';
        $('dbPass').value = '';
        $('dbDatabase').value = '';
    }
    
    function closeAddModal() {
        $('addModal').classList.remove('open');
    }
    
    async function testAndSave() {
        const conn = {
            name: $('dbName').value || $('dbHost').value,
            host: $('dbHost').value,
            port: $('dbPort').value,
            user: $('dbUser').value,
            password: $('dbPass').value,
            database: $('dbDatabase').value
        };
        
        if (!conn.host || !conn.user) {
            alert('è¯·å¡«å†™ä¸»æœºå’Œç”¨æˆ·å');
            return;
        }
        
        try {
            const r = await fetch('/api/db/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(conn)
            });
            const data = await r.json();
            
            if (data.success) {
                // ä¿å­˜
                const saveR = await fetch('/api/db/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(conn)
                });
                const saveData = await saveR.json();
                if (saveData.success) {
                    closeAddModal();
                    loadConnections();
                    showStatus('è¿æ¥å·²ä¿å­˜');
                } else {
                    alert(saveData.error || 'ä¿å­˜å¤±è´¥');
                }
            } else {
                alert(data.message || 'è¿æ¥å¤±è´¥');
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    // æ•°æ®åº“ç®¡ç†
    function openDbModal() {
        if (!currentConn) {
            alert('è¯·å…ˆé€‰æ‹©è¿æ¥');
            return;
        }
        $('dbModal').classList.add('open');
        $('newDbName').value = '';
    }
    
    function closeDbModal() {
        $('dbModal').classList.remove('open');
    }
    
    async function createDatabase() {
        const name = $('newDbName').value.trim();
        if (!name) return;
        
        const charset = $('dbCharset').value;
        const sql = `CREATE DATABASE \`${name}\` CHARACTER SET ${charset}`;
        
        try {
            const r = await fetch('/api/db/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    connection: currentConn.id,
                    query: sql
                })
            });
            const data = await r.json();
            
            if (data.success) {
                closeDbModal();
                loadDatabases();
                showStatus('æ•°æ®åº“å·²åˆ›å»º');
            } else {
                alert(data.error || 'åˆ›å»ºå¤±è´¥');
            }
        } catch (e) {
            alert(e.message);
        }
    }
    
    // SQL ç¼–è¾‘å™¨å¿«æ·é”®
    $('sqlEditor').addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            executeQuery();
        }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­å†å²é¢æ¿
    document.addEventListener('click', e => {
        if (!e.target.closest('.history-btn') && !e.target.closest('.history-panel')) {
            $('historyPanel').classList.remove('open');
        }
    });
    
    // åˆå§‹åŒ–
    loadConnections();
    </script>
</body>
</html>
