<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°æ®åº“ç®¡ç†</title>
    <script src="/static/js/clipboard.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e; color: #e0e0e0;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }
        
        /* æ‚¬æµ®æŒ‰é’® */
        .float-btn {
            position: fixed; left: 16px; bottom: 40px; z-index: 100;
            width: 44px; height: 44px; border-radius: 12px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
        }
        .float-btn:hover { transform: scale(1.05); }
        .float-btn svg { width: 22px; height: 22px; fill: #fff; }
        
        /* æŠ½å±‰ä¾§è¾¹æ  */
        .drawer {
            position: fixed; left: -100%; top: 0; bottom: 0;
            width: 60%; max-width: 320px; z-index: 200;
            background: #16213e; border-right: 1px solid #0f3460;
            display: flex; flex-direction: column;
            transition: left 0.3s ease;
        }
        .drawer.open { left: 0; }
        .drawer-backdrop {
            position: fixed; inset: 0; z-index: 150;
            background: rgba(0,0,0,0.6);
            opacity: 0; visibility: hidden;
        }
        .drawer-backdrop.show { opacity: 1; visibility: visible; }
        .drawer-header {
            padding: 14px; border-bottom: 1px solid #0f3460;
            display: flex; align-items: center; justify-content: space-between;
        }
        .drawer-header h2 { font-size: 15px; font-weight: 500; color: #fff; }
        .drawer-close {
            width: 32px; height: 32px; border-radius: 8px;
            background: #0f3460; border: none; color: #888;
            cursor: pointer; font-size: 20px;
        }
        .drawer-content { flex: 1; overflow-y: auto; padding: 12px; }
        
        /* æ ‘ç»„ä»¶ */
        .tree { font-size: 13px; }
        .tree-node { }
        .tree-node-content {
            padding: 8px 10px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: background 0.15s;
        }
        .tree-node-content:hover { background: #0f3460; }
        .tree-node-content.active { background: #0f3460; color: #e94560; }
        .tree-toggle {
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #666; flex-shrink: 0;
        }
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-icon { width: 18px; text-align: center; flex-shrink: 0; }
        .tree-label { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tree-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
        .tree-node-content:hover .tree-actions { opacity: 1; }
        .tree-actions button {
            padding: 2px 6px; border-radius: 4px; border: none;
            background: rgba(255,255,255,0.1); color: #888; cursor: pointer; font-size: 10px;
        }
        .tree-actions button:hover { background: #e94560; color: #fff; }
        .tree-children { padding-left: 20px; overflow: hidden; }
        .tree-children.collapsed { display: none; }
        .tree-loading { padding: 10px; text-align: center; color: #666; font-size: 12px; }
        
        /* æ–°å»ºæŒ‰é’® */
        .add-btn {
            width: 100%; padding: 10px; border-radius: 8px;
            background: #0f3460; border: none; color: #ccc;
            cursor: pointer; font-size: 13px; margin-bottom: 12px;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1; display: flex; flex-direction: column;
            padding: 5px 16px 16px 16px; overflow: hidden;
        }
        .top-bar {
            flex-shrink: 0; display: flex; align-items: center; gap: 8px;
            margin-bottom: 4px; flex-wrap: wrap;
        }
        .top-bar h1 { font-size: 18px; font-weight: 500; color: #fff; }
        .breadcrumb {
            display: flex; align-items: center; gap: 6px; font-size: 12px; color: #888;
            flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .breadcrumb span { color: #e94560; }
        
        /* SQL ç¼–è¾‘å™¨ */
        .sql-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; background: #0f3460; border-radius: 10px;
            cursor: pointer; margin-bottom: 2px;
        }
        .sql-toggle span { font-size: 13px; color: #ccc; }
        .sql-toggle .arrow { transition: transform 0.3s; font-size: 12px; color: #888; }
        .sql-toggle.open .arrow { transform: rotate(180deg); }
        .sql-editor {
            display: none; flex-direction: column;
            background: #16213e; border-radius: 10px; padding: 12px;
        }
        .sql-editor.open { display: flex; }
        .sql-editor textarea {
            width: 100%; height: 80px; background: #1a1a2e; border: none;
            padding: 12px; resize: none; outline: none;
            color: #fff; font-family: 'SF Mono', monospace; font-size: 12px;
            border-radius: 6px;
        }
        .sql-toolbar { display: flex; gap: 8px; padding: 10px 0; flex-wrap: wrap; align-items: center; }
        .sql-toolbar button {
            padding: 8px 14px; border-radius: 6px; border: none;
            background: #e94560; color: #fff; cursor: pointer; font-size: 12px;
        }
        .sql-toolbar button.secondary { background: #0f3460; }
        .quick-btns { display: flex; gap: 6px; flex-wrap: wrap; margin-left: auto; }
        .quick-btns button {
            background: #0f3460; border: none; padding: 6px 10px; font-size: 11px;
            border-radius: 5px; color: #ccc; cursor: pointer;
        }
        
        /* å¯¼å‡ºå’Œåˆ†é¡µ */
        .results-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; gap: 16px;
        }
        .export-btns { display: flex; gap: 6px; }
        .export-btn {
            padding: 4px 10px; font-size: 11px; border-radius: 4px;
            background: #0f3460; border: none; color: #ccc; cursor: pointer;
        }
        .pagination { display: flex; align-items: center; gap: 8px; }
        .page-btn {
            padding: 4px 8px; font-size: 11px; border-radius: 4px;
            background: #0f3460; border: none; color: #ccc; cursor: pointer;
        }
        .page-info { font-size: 11px; color: #888; min-width: 60px; text-align: center; }
        
        /* ç»“æœåŒº */
        .results-tabs { display: flex; gap: 4px; padding: 8px 0; }
        .results-tab {
            padding: 6px 12px; border-radius: 6px; border: none;
            background: transparent; color: #888; cursor: pointer; font-size: 12px;
        }
        .results-tab.active { background: #0f3460; color: #e94560; }
        .results {
            flex: 1; overflow: auto; background: #16213e; border-radius: 12px;
            border: 1px solid #0f3460;
        }
        .results-empty { text-align: center; color: #666; padding: 30px; }
        .loading { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 20px; color: #666; }
        .spinner {
            width: 18px; height: 18px; border: 2px solid #0f3460;
            border-top-color: #e94560; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* æ•°æ®è¡¨æ ¼ */
        .data-table-wrapper { overflow: auto; max-height: 100%; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table th, .data-table td {
            padding: 10px 12px; text-align: left; border-bottom: 1px solid #0f3460;
            white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
        }
        .data-table th {
            background: #1a1a2e; color: #e94560; font-weight: 500;
            position: sticky; top: 0; z-index: 10;
        }
        .data-table td { color: #ccc; font-family: 'SF Mono', monospace; font-size: 11px; cursor: pointer; }
        .data-table td:hover { background: #1a2a4a; }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            flex-shrink: 0;
            display: flex; align-items: center; gap: 12px; padding: 10px 14px;
            background: #16213e; border-radius: 8px; margin-top: 10px;
            font-size: 11px; color: #888;
        }
        .status-bar .success { color: #4ade80; }
        .status-bar .error { color: #ef4444; }
        
        /* å¼¹çª— */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; z-index: 300;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content { background: #16213e; border-radius: 12px; padding: 20px; max-width: 360px; width: 100%; }
        .modal-title { font-size: 16px; font-weight: 500; margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #0f3460;
            border-radius: 8px; color: #fff; font-size: 14px;
        }
        .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        .modal-actions button {
            flex: 1; padding: 12px; border-radius: 8px; border: none;
            cursor: pointer; font-size: 14px;
        }
        .modal-actions .cancel { background: #0f3460; color: #ccc; }
        .modal-actions .confirm { background: #e94560; color: #fff; }
    </style>
</head>
<body>
    <div id="app">
        <!-- æ‚¬æµ®æŒ‰é’® -->
        <button class="float-btn" onclick="toggleDrawer()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        
        <!-- æŠ½å±‰é®ç½© -->
        <div class="drawer-backdrop" id="drawerBackdrop" onclick="closeDrawer()"></div>
        
        <!-- æŠ½å±‰ -->
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <h2>ğŸ“Š æ•°æ®åº“</h2>
                <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
            </div>
            <div class="drawer-content">
                <button class="add-btn" onclick="openAddModal()">+ æ–°å»ºè¿æ¥</button>
                <div class="tree" id="dbTree"></div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="top-bar">
                <h1>æ•°æ®åº“</h1>
                <div class="breadcrumb" id="breadcrumb"><span>æœªé€‰æ‹©</span></div>
            </div>
            
            <!-- SQL ç¼–è¾‘å™¨ -->
            <div class="sql-toggle" id="sqlToggle" onclick="toggleSqlEditor()">
                <span>ğŸ“ SQL æŸ¥è¯¢</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="sql-editor" id="sqlEditorPanel">
                <textarea id="sqlEditor" placeholder="è¾“å…¥ SQL... (Ctrl+Enter æ‰§è¡Œ)"></textarea>
                <div class="sql-toolbar">
                    <button onclick="executeQuery()">â–¶ æ‰§è¡Œ</button>
                    <button class="secondary" onclick="clearEditor()">æ¸…ç©º</button>
                    <div class="quick-btns">
                        <button onclick="quickQuery('SHOW TABLES')">Tables</button>
                        <button onclick="quickQuery('SHOW PROCESSLIST')">Process</button>
                        <button onclick="quickQuery('DESCRIBE \`table_name\`')">Desc</button>
                        <button onclick="quickQuery('SELECT COUNT(*) FROM \`table_name\`')">Count</button>
                    </div>
                </div>
            </div>
            
            <!-- å·¥å…·æ  -->
            <div class="results-toolbar" id="resultsToolbar" style="display:none;">
                <div class="export-btns">
                    <button class="export-btn" onclick="exportData('csv')">CSV</button>
                    <button class="export-btn" onclick="exportData('xls')">XLS</button>
                    <button class="export-btn" onclick="exportData('sql')">SQL</button>
                </div>
                <div class="pagination" id="paginationControls">
                    <button class="page-btn" onclick="goToPage(1)">Â«</button>
                    <button class="page-btn" onclick="goToPage(currentPage-1)">â€¹</button>
                    <span class="page-info" id="pageInfo">1 / 1</span>
                    <button class="page-btn" onclick="goToPage(currentPage+1)">â€º</button>
                    <button class="page-btn" onclick="goToPage(totalPages)">Â»</button>
                </div>
            </div>
            
            <!-- ç»“æœ -->
            <div class="results-tabs">
                <button class="results-tab active" id="tabResults" onclick="switchResultsTab('results')">æ•°æ®</button>
                <button class="results-tab" id="tabSchema" onclick="switchResultsTab('schema')">ç»“æ„</button>
            </div>
            <div class="results" id="resultsContent">
                <div class="results-empty">é€‰æ‹©è¡¨åè‡ªåŠ¨æŸ¥è¯¢</div>
            </div>
            <div class="results" id="schemaPanel" style="display:none;">
                <div class="results-empty">é€‰æ‹©è¡¨æŸ¥çœ‹ç»“æ„</div>
            </div>
            
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar" id="statusBar"><span>å°±ç»ª</span></div>
        </div>
    </div>
    
    <!-- æ·»åŠ è¿æ¥å¼¹çª— -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ–°å»ºè¿æ¥</div>
            <div class="form-group">
                <label>æ•°æ®åº“å¼•æ“</label>
                <select id="dbEngine">
                    <option value="mysql">MySQL</option>
                    <option value="postgresql">PostgreSQL</option>
                    <option value="sqlite">SQLite</option>
                    <option value="mariadb">MariaDB</option>
                    <option value="oracle">Oracle</option>
                    <option value="mssql">SQL Server</option>
                </select>
            </div>
            <div class="form-group"><label>åç§°</label><input type="text" id="dbName" placeholder="ä¾‹å¦‚: ç”Ÿäº§åº“"></div>
            <div class="form-group host-field"><label>ä¸»æœº</label><input type="text" id="dbHost" placeholder="localhost"></div>
            <div class="form-group host-field"><label>ç«¯å£</label><input type="number" id="dbPort" value="3306"></div>
            <div class="form-group host-field"><label>ç”¨æˆ·å</label><input type="text" id="dbUser" placeholder="root"></div>
            <div class="form-group host-field"><label>å¯†ç </label><input type="password" id="dbPass" placeholder="å¯†ç "></div>
            <div class="form-group db-field"><label>æ•°æ®åº“</label><input type="text" id="dbDatabase" placeholder="æ•°æ®åº“å"></div>
            <div class="form-group sqlite-field" style="display:none;"><label>æ–‡ä»¶è·¯å¾„</label><input type="text" id="dbSqlitePath" placeholder="/path/to/db.sqlite"></div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="testAndSave()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘è¿æ¥å¼¹çª— -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘è¿æ¥</div>
            <input type="hidden" id="editConnId">
            <div class="form-group"><label>SQLAlchemy URL</label><div style="display:flex;gap:8px;"><input type="text" id="editDbUrl" readonly style="background:#0f3460;color:#4ade80;font-size:11px;"><button onclick="copyDbUrl()" style="background:#0f3460;border:none;border-radius:8px;color:#ccc;cursor:pointer;padding:0 12px;">å¤åˆ¶</button></div></div>
            <div class="form-group"><label>åç§°</label><input type="text" id="editDbName"></div>
            <div class="form-group host-field"><label>ä¸»æœº</label><input type="text" id="editDbHost"></div>
            <div class="form-group host-field"><label>ç«¯å£</label><input type="number" id="editDbPort"></div>
            <div class="form-group host-field"><label>ç”¨æˆ·å</label><input type="text" id="editDbUser"></div>
            <div class="form-group host-field"><label>å¯†ç </label><input type="password" id="editDbPass" placeholder="ç•™ç©ºä¿æŒåŸå¯†ç "></div>
            <div class="form-group db-field"><label>æ•°æ®åº“</label><input type="text" id="editDbDatabase"></div>
            <div class="form-group sqlite-field" style="display:none;"><label>æ–‡ä»¶è·¯å¾„</label><input type="text" id="editDbSqlitePath"></div>
            <div class="modal-actions">
                <button class="cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="confirm" onclick="saveEditConnection()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm å¼¹çª— -->
    <div id="confirmBackdrop" class="modal" onclick="closeConfirmModal()" style="display:none;background:rgba(0,0,0,0.5);">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width:320px;">
            <div class="modal-title" id="confirmTitle">ç¡®è®¤</div>
            <div id="confirmMessage" style="color:#888;margin-bottom:20px;"></div>
            <div style="display:flex;gap:12px;justify-content:flex-end;">
                <button onclick="closeConfirmModal()" style="padding:10px 16px;background:#0f3460;border:none;border-radius:8px;color:#ccc;cursor:pointer;">å–æ¶ˆ</button>
                <button id="confirmBtn" onclick="performConfirm()" style="padding:10px 16px;border:none;border-radius:8px;color:#fff;cursor:pointer;">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <script>
        const $ = id => document.getElementById(id);
        let connections = [], currentConn = null, currentDb = null, currentTable = null;
        let allResults = [], currentPage = 1, totalPages = 1, pageSize = 200;
        let __confirmCallback = null;
        
        const ENGINE_CONFIG = {
            mysql: { port: 3306, icon: 'ğŸ¬' }, postgresql: { port: 5432, icon: 'ğŸ˜' },
            sqlite: { port: 0, icon: 'ğŸ“„' }, mariadb: { port: 3306, icon: 'ğŸ¬' },
            oracle: { port: 1521, icon: 'ğŸ”´' }, mssql: { port: 1433, icon: 'ğŸªŸ' }
        };
        
        // åŠ è½½æ ‘æ•°æ®
        async function loadTree() {
            $('dbTree').innerHTML = '<div class="tree-loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const r = await fetch('/api/db/tree');
                const data = await r.json();
                if (data.success) {
                    renderTree(data.data || []);
                } else {
                    $('dbTree').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>';
                }
            } catch (e) {
                $('dbTree').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // æ¸²æŸ“æ ‘
        function renderTree(treeData) {
            let html = '<div class="tree">';
            treeData.forEach(conn => {
                html += renderTreeNode(conn, 'conn', null);
            });
            html += '</div>';
            $('dbTree').innerHTML = html || '<div class="results-empty">æš‚æ— è¿æ¥</div>';
        }
        
        function renderTreeNode(node, type, parentConnId) {
            const id = type === 'conn' ? node.id : node.name;
            const connId = type === 'conn' ? node.id : parentConnId;
            const label = type === 'conn' ? node.name : node.name;
            const icon = type === 'conn' ? (ENGINE_CONFIG[node.engine || 'mysql']?.icon || 'ğŸ—„ï¸') : (type === 'db' ? 'ğŸ“' : 'ğŸ“‹');
            const hasChildren = node.children && node.children.length > 0 && type !== 'table';
            const expanded = type === 'conn';
            
            let html = `<div class="tree-node" data-type="${type}" data-id="${id}" data-connid="${connId}" data-db="${type === 'conn' ? node.database : (type === 'db' ? node.name : parentConnId)}">
                <div class="tree-node-content" onclick="onNodeClick(this, '${type}', '${id}', '${type === 'db' ? node.name : (type === 'table' ? parentConnId : node.database)}')">
                    ${type === 'table' ? '' : `<span class="tree-toggle ${expanded ? 'expanded' : ''}" onclick="event.stopPropagation();toggleNode(this)">â–¶</span>`}
                    <span class="tree-icon">${icon}</span>
                    <span class="tree-label">${label}</span>
                    ${type === 'conn' ? `<div class="tree-actions">
                        <button onclick="event.stopPropagation();openEditModal('${id}')">ç¼–è¾‘</button>
                        <button onclick="event.stopPropagation();deleteConnection('${id}')">åˆ é™¤</button>
                    </div>` : ''}
                </div>`;
            
            if (hasChildren) {
                html += `<div class="tree-children ${expanded ? '' : 'collapsed'}">`;
                node.children.forEach(child => {
                    const childType = type === 'conn' ? 'db' : (child.children && child.children.length > 0 ? 'db' : 'table');
                    html += renderTreeNode(child, childType, connId);
                });
                html += '</div>';
            }
            html += '</div>';
            return html;
        }
        
        function toggleNode(el) {
            el.classList.toggle('expanded');
            const children = el.parentElement.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('collapsed');
            }
        }
        
        async function onNodeClick(el, type, id, dbName) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tree-node-content').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            if (type === 'table') {
                // ç‚¹å‡»è¡¨
                const nodeEl = el.closest('.tree-node');
                const connId = nodeEl.dataset.connid;
                const db = nodeEl.dataset.db;
                const conn = connections.find(c => c.id === connId);
                if (!conn) { console.error('Connection not found:', connId); return; }
                currentConn = conn;
                currentDb = db;
                currentTable = id;
                updateBreadcrumb();
                
                // å…³é—­ä¾§è¾¹æ 
                closeDrawer();
                
                // æ‰§è¡ŒæŸ¥è¯¢
                const sql = `SELECT * FROM \`${id}\` LIMIT 200`;
                $('sqlEditor').value = sql;
                $('sqlEditorPanel').classList.add('open');
                $('sqlToggle').classList.add('open');
                executeQuery();
            }
        }
        
        function updateBreadcrumb() {
            let html = '';
            if (currentConn) html += `<span>${currentConn.name}</span>`;
            if (currentDb) html += ` / <span>${currentDb}</span>`;
            if (currentTable) html += ` / <span>${currentTable}</span>`;
            $('breadcrumb').innerHTML = html || '<span>æœªé€‰æ‹©</span>';
        }
        
        function toggleDrawer() { $('drawer').classList.toggle('open'); $('drawerBackdrop').classList.toggle('show'); }
        function closeDrawer() { $('drawer').classList.remove('open'); $('drawerBackdrop').classList.remove('show'); }
        
        function toggleSqlEditor() { $('sqlEditorPanel').classList.toggle('open'); $('sqlToggle').classList.toggle('open'); }
        function clearEditor() { $('sqlEditor').value = ''; }
        
        async function executeQuery() {
            const sql = $('sqlEditor').value.trim();
            if (!sql) return;
            $('resultsContent').innerHTML = '<div class="loading"><div class="spinner"></div>æ‰§è¡Œä¸­...</div>';
            
            try {
                const r = await fetch('/api/db/execute', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ connection: currentConn.id, query: sql })
                });
                const data = await r.json();
                if (data.success) {
                    allResults = data.data?.rows || [];
                    currentPage = 1;
                    totalPages = Math.ceil(allResults.length / pageSize);
                    renderResults(data.data.headers || [], getPageData());
                    showStatus(`æˆåŠŸ ${allResults.length} è¡Œ`, false);
                    $('resultsToolbar').style.display = allResults.length > pageSize ? 'flex' : 'none';
                } else {
                    showStatus('å¤±è´¥: ' + data.message, true);
                    $('resultsContent').innerHTML = `<div class="results-empty" style="color:#ef4444;">${data.message}</div>`;
                    $('resultsToolbar').style.display = 'none';
                }
            } catch (e) {
                showStatus('å¤±è´¥: ' + e.message, true);
                $('resultsContent').innerHTML = `<div class="results-empty" style="color:#ef4444;">${e.message}</div>`;
            }
        }
        
        function getPageData() {
            const start = (currentPage - 1) * pageSize;
            return allResults.slice(start, start + pageSize);
        }
        
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            const headers = $('resultsContent').querySelectorAll('thead th');
            const headerArr = Array.from(headers).map(th => th.textContent);
            renderResults(headerArr, getPageData());
        }
        
        function renderResults(headers, rows) {
            $('resultsContent').innerHTML = rows.length === 0 
                ? '<div class="results-empty">æ— æ•°æ®</div>' 
                : `<div class="data-table-wrapper"><table class="data-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.map(row => `<tr>${row.map(cell => `<td>${cell||''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            $('pageInfo').textContent = `${currentPage} / ${totalPages}`;
        }
        
        function quickQuery(sql) {
            if (!currentConn) { showStatus('è¯·å…ˆé€‰æ‹©è¡¨', true); return; }
            $('sqlEditor').value = sql;
            $('sqlEditorPanel').classList.add('open');
            $('sqlToggle').classList.add('open');
            executeQuery();
        }
        
        function exportData(format) {
            if (allResults.length === 0) { showStatus('æ— å¯å¯¼å‡ºæ•°æ®', true); return; }
            const headers = $('resultsContent').querySelectorAll('thead th');
            const headerArr = Array.from(headers).map(th => th.textContent);
            let content = '', filename = `export_${Date.now()}`;
            
            if (format === 'csv') {
                content = headerArr.map(h => `"${h}"`).join(',') + '\n';
                allResults.forEach(row => content += row.map(cell => `"${(cell||'').replace(/"/g, '""')}"`).join(',') + '\n');
                filename += '.csv';
            } else if (format === 'xls') {
                content = '<html><meta charset="utf-8"><table border="1"><tr>' + headerArr.map(h => `<th style="background:#eee;padding:4px;">${h}</th>`).join('') + '</tr>' + allResults.map(row => '<tr>' + row.map(cell => `<td style="padding:4px;">${cell||''}</td>`).join('') + '</tr>').join('') + '</table></html>';
                filename += '.xls';
            } else if (format === 'sql') {
                const table = currentTable || 'table_name';
                content = `-- ${table}\n`;
                allResults.forEach(row => {
                    const vals = row.map(cell => cell === null ? 'NULL' : typeof cell === 'number' ? cell : `'${String(cell).replace(/'/g, "''")}'`).join(', ');
                    content += `INSERT INTO \`${table}\` VALUES (${vals});\n`;
                });
                filename += '.sql';
            }
            const blob = new Blob([content], {type: format === 'csv' ? 'text/csv' : 'application/vnd.ms-excel'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(blob);
            showStatus(`å·²å¯¼å‡º ${allResults.length} è¡Œ`, false);
        }
        
        function switchResultsTab(tab) {
            document.querySelectorAll('.results-tab').forEach(t => t.classList.remove('active'));
            $('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            $('resultsContent').style.display = tab === 'results' ? 'block' : 'none';
            $('schemaPanel').style.display = tab === 'schema' ? 'block' : 'none';
            if (tab === 'schema' && currentTable) loadTableSchema();
        }
        
        async function loadTableSchema() {
            if (!currentConn || !currentTable) return;
            $('schemaPanel').innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
            try {
                const r = await fetch(`/api/db/${currentConn.id}/table/${currentTable}/schema`);
                const data = await r.json();
                if (data.success) {
                    const cols = data.data?.columns || [];
                    $('schemaPanel').innerHTML = cols.length ? `<table class="data-table"><thead><tr><th>åˆ—å</th><th>ç±»å‹</th><th>å¯ç©º</th><th>é”®</th></tr></thead><tbody>` + 
                        cols.map(c => `<tr><td>${c.field}</td><td>${c.type}</td><td>${c.null === 'YES' ? 'âœ“' : 'âœ—'}</td><td>${c.key || ''}</td></tr>`).join('') + '</tbody></table>' : '<div class="results-empty">æ— ç»“æ„</div>';
                }
            } catch (e) { $('schemaPanel').innerHTML = '<div class="results-empty">åŠ è½½å¤±è´¥</div>'; }
        }
        
        function showStatus(msg, error) { $('statusBar').innerHTML = `<span class="${error ? 'error' : 'success'}">${msg}</span>`; }
        
        function showConfirm(title, msg, onConfirm, danger) {
            $('confirmTitle').textContent = title;
            $('confirmMessage').textContent = msg;
            __confirmCallback = onConfirm;
            $('confirmBtn').className = danger ? 'confirm' : '';
            $('confirmBtn').textContent = danger ? 'åˆ é™¤' : 'ç¡®è®¤';
            $('confirmBackdrop').style.display = 'flex';
        }
        function performConfirm() { if (__confirmCallback) __confirmCallback(); closeConfirmModal(); }
        function closeConfirmModal() { $('confirmBackdrop').style.display = 'none'; }
        
        function copyToClipboard(text) {
            if (typeof clipboard !== 'undefined' && clipboard.copy) clipboard.copy(text).then(() => showStatus('å·²å¤åˆ¶', false)).catch(() => fallbackCopy(text));
            else fallbackCopy(text);
        }
        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); showStatus('å·²å¤åˆ¶', false); } catch (e) { showStatus('å¤åˆ¶å¤±è´¥', true); }
            document.body.removeChild(ta);
        }
        
        // æ·»åŠ è¿æ¥
        function openAddModal() {
            $('dbEngine').value = 'mysql'; $('dbName').value = ''; $('dbHost').value = ''; $('dbPort').value = '3306';
            $('dbUser').value = ''; $('dbPass').value = ''; $('dbDatabase').value = ''; $('dbSqlitePath').value = '';
            updateEngineFields();
            $('addModal').classList.add('show');
        }
        function closeAddModal() { $('addModal').classList.remove('show'); }
        function updateEngineFields() {
            const eng = $('dbEngine').value;
            document.querySelectorAll('.host-field').forEach(el => el.style.display = eng === 'sqlite' ? 'none' : 'block');
            document.querySelectorAll('.sqlite-field').forEach(el => el.style.display = eng === 'sqlite' ? 'block' : 'none');
        }
        async function testAndSave() {
            const eng = $('dbEngine').value;
            const data = {name:$('dbName').value, engine:eng, host:eng==='sqlite'?'':$('dbHost').value, port:String($('dbPort').value||ENGINE_CONFIG[eng]?.port||3306), 
                user:eng==='sqlite'?'':$('dbUser').value, password:eng==='sqlite'?'':$('dbPass').value, database:eng==='sqlite'?$('dbSqlitePath').value:$('dbDatabase').value};
            if (!data.name) { showStatus('è¯·å¡«å†™åç§°', true); return; }
            if (eng !== 'sqlite' && (!data.host || !data.user)) { showStatus('è¯·å¡«å†™å¿…è¦ä¿¡æ¯', true); return; }
            try {
                await fetch('/api/db/connect', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                closeAddModal(); loadTree(); loadConnections(); showStatus('å·²ä¿å­˜', false);
            } catch (e) { showStatus('ä¿å­˜å¤±è´¥: ' + e.message, true); }
        }
        
        // ç¼–è¾‘è¿æ¥
        async function openEditModal(id) {
            const conn = connections.find(c => c.id === id);
            if (!conn) return;
            $('editConnId').value = id; $('editDbName').value = conn.name || '';
            $('editDbHost').value = conn.host || ''; $('editDbPort').value = conn.port || '';
            $('editDbUser').value = conn.user || ''; $('editDbPass').value = '';
            $('editDbDatabase').value = conn.database || ''; $('editDbSqlitePath').value = conn.engine === 'sqlite' ? conn.database : '';
            const url = `${conn.engine || 'mysql'}://${conn.user||''}:***@${conn.host||''}:${conn.port||3306}/${conn.database||''}`;
            $('editDbUrl').value = url;
            $('editModal').classList.add('show');
        }
        function closeEditModal() { $('editModal').classList.remove('show'); }
        function copyDbUrl() { copyToClipboard($('editDbUrl').value); }
        async function saveEditConnection() {
            const id = $('editConnId').value;
            const eng = connections.find(c => c.id === id)?.engine || 'mysql';
            const data = {name:$('editDbName').value, engine:eng, host:$('editDbHost').value, port:String($('editDbPort').value), user:$('editDbUser').value, password:$('editDbPass').value, database:$('editDbDatabase').value};
            try {
                await fetch(`/api/db/connection/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                closeEditModal(); loadTree(); loadConnections(); showStatus('å·²æ›´æ–°', false);
            } catch (e) { showStatus('ä¿å­˜å¤±è´¥', true); }
        }
        
        function deleteConnection(id) {
            showConfirm('åˆ é™¤è¿æ¥', 'ç¡®å®šè¦åˆ é™¤æ­¤è¿æ¥å—ï¼Ÿ', async () => {
                try {
                    await fetch(`/api/db/connections/${id}`, {method:'DELETE'});
                    currentConn = null; currentDb = null; currentTable = null;
                    loadTree(); loadConnections(); updateBreadcrumb(); showStatus('å·²åˆ é™¤', false);
                } catch (e) { showStatus('åˆ é™¤å¤±è´¥', true); }
            }, true);
        }
        
        async function loadConnections() {
            const r = await fetch('/api/db/connections');
            const data = await r.json();
            if (data.success) connections = data.data?.connections || [];
        }
        
        document.addEventListener('keydown', e => { if ((e.ctrlKey||e.metaKey) && e.key==='Enter') executeQuery(); });
        loadConnections().then(loadTree);
    </script>
</body>
</html>
