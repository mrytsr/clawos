<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仓库管理</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); padding: 10px 12px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; }
        .header a { color: #fff; text-decoration: none; font-size: 20px; }
        .header h1 { font-size: 15px; font-weight: 500; flex: 1; }
        .container { padding: 10px; }
        .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-secondary { background: #4b5563; color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-sm { padding: 3px 8px; font-size: 11px; }
        .list-item { background: #1e2a4a; border-radius: 6px; padding: 12px 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .list-item:active { background: #2a3a5a; }
        .list-item .name { flex: 1; font-size: 14px; }
        .list-item .tags { font-size: 11px; color: #888; }
        .list-item .tag { background: #2a3a5a; padding: 2px 6px; border-radius: 3px; margin-right: 4px; }
        .empty { text-align: center; padding: 30px; color: #666; font-size: 13px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: #1a1a2e; border-radius: 10px; padding: 16px; width: 100%; max-width: 350px; }
        .modal h3 { margin-bottom: 12px; font-size: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 3px; color: #888; font-size: 12px; }
        .form-group input { width: 100%; padding: 8px 10px; background: #16213e; border: 1px solid #2a3a5a; border-radius: 5px; color: #fff; font-size: 13px; }
        .modal-buttons { display: flex; gap: 6px; justify-content: flex-end; margin-top: 12px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            
            <h1>仓库</h1>
            <button class="btn btn-primary btn-sm" @click="showAdd = true">+ 仓库</button>
        </div>
        <div class="container">
            <div v-if="warehouses.length === 0" class="empty">暂无仓库</div>
            <div v-else>
                <div v-for="w in warehouses" :key="w.id" class="list-item" @click="goProducts(w.id)">
                    <div class="name">{{ w.name }}</div>
                    <div class="tags">
                        <span class="tag">品{{ w.product_count || 0 }}</span>
                        <span class="tag">明{{ w.tx_count || 0 }}</span>
                        <span class="tag">¥{{ formatNumber(w.total_value || 0) }}</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" @click.stop="editWarehouse(w)">编</button>
                    <button class="btn btn-danger btn-sm" @click.stop="deleteWarehouse(w.id)">删</button>
                </div>
            </div>
        </div>
        <div v-if="showAdd" class="modal-overlay" @click.self="showAdd = false">
            <div class="modal">
                <h3>添加仓库</h3>
                <div class="form-group"><label>名称</label><input v-model="formName" placeholder="仓库名称"></div>
                <div class="modal-buttons">
                    <button class="btn" @click="showAdd = false">取消</button>
                    <button class="btn btn-primary" @click="addWarehouse">确定</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const { createApp, ref } = Vue;
        createApp({
            data() { return { warehouses: [], showAdd: false, formName: '' }; },
            mounted() { this.loadWarehouses(); },
            methods: {
                async loadWarehouses() {
                    const res = await fetch('/warehouse/api/warehouses');
                    this.warehouses = await res.json();
                    for (let w of this.warehouses) {
                        try {
                            const r = await fetch('/warehouse/api/warehouses/' + w.id);
                            const d = await r.json();
                            w.product_count = d.product_count || 0;
                            w.total_value = d.total_value || 0;
                            const tr = await fetch('/warehouse/api/warehouse/' + w.id + '/all-transactions?limit=1000');
                            const td = await tr.json();
                            w.tx_count = td.length || 0;
                        } catch(e) {}
                    }
                },
                async addWarehouse() {
                    if (!this.formName) return;
                    await fetch('/warehouse/api/warehouses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: this.formName })
                    });
                    this.showAdd = false;
                    this.formName = '';
                    this.loadWarehouses();
                },
                editWarehouse(w) {
                    const name = prompt('仓库名称', w.name);
                    if (name && name !== w.name) {
                        fetch('/warehouse/api/warehouses/' + w.id, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        }).then(() => this.loadWarehouses());
                    }
                },
                deleteWarehouse(id) {
                    if (confirm('确定删除仓库？')) {
                        fetch('/warehouse/api/warehouses/' + id, { method: 'DELETE' })
                            .then(() => this.loadWarehouses());
                    }
                },
                goProducts(id) { window.location.href = '/warehouse/products/' + id; },
                formatNumber(n) { return Math.round(n).toLocaleString(); }
            }
        }).mount('#app');
    </script>
</body>
</html>
